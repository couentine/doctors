<!-- #=== POLYMER & SHIMS ===# -->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- #=== STANDARD POLYMER COMPONENTS ===# -->
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<!-- #=== BADGE LIST COMPONENTS ===# -->
<link rel="import" href="../bl-styles/bl-styles.html">
<link rel="import" href="../bl-styles/fonts.html">
<link rel="import" href="../bl-toast/bl-toast.html">
<link rel="import" href="../bl-views/bl-view-pricing.html">
<link rel="import" href="../bl-views/bl-view-privacy-policy.html">
<link rel="import" href="../bl-views/bl-view-terms-of-service.html">
<link rel="import" href="../bl-views/bl-view-web-page.html">

<!--
# Badge List Website #
-->
<dom-module id="bl-website">
  <template>

    <style include="bl-style-classes">

      /* === LAYOUT & BASE STYLES === */
        
        :host {
          @apply --bl-font-common-base;
          
          display: block;
          position: absolute;
          top: 0; right: 0; bottom: 0; left: 0;
        }
      
      /* === TOAST CONTAINER === */

        #toastContainer {
          display: block;
          position: fixed;
          top: 2em; right: 0; left: 0;
          z-index: 150;
        }

    </style>

    <!-- #=== APP ROUTING ===# -->
    
    <app-location id="location" route="{{route}}" 
      url-space-regex="(^/$)|(^/w$)|(^/how-it-works$)|(^/pricing$)|(^/privacy-policy$)|(^/terms-of-service$)|(^/docs$)"></app-location>
    
    <app-route
      pattern="/"
      route="{{route}}"
      id="indexRoute"
      active="{{indexRouteActive}}"
    ></app-route>

    <app-route
      pattern="/w"
      route="{{route}}"
      id="webRoute"
      active="{{webRouteActive}}"
    ></app-route>

    <app-route
      pattern="/how-it-works"
      id="howItWorksViewRoute"
      active="{{howItWorksViewActive}}"
      route="{{route}}"
    ></app-route>

    <app-route
      pattern="/pricing"
      id="pricingViewRoute"
      active="{{pricingViewActive}}"
      route="{{route}}"
    ></app-route>

    <app-route
      pattern="/docs"
      id="docsViewRoute"
      active="{{docsViewActive}}"
      route="{{route}}"
    ></app-route>

    <app-route
      pattern="/privacy-policy"
      id="privacyPolicyViewRoute"
      active="{{privacyPolicyViewActive}}"
      route="{{route}}"
    ></app-route>

    <app-route
      pattern="/terms-of-service"
      id="termsOfServiceViewRoute"
      active="{{termsOfServiceViewActive}}"
      route="{{route}}" 
    ></app-route>

    <app-route
      pattern="/for/:key"
      id="forPageRoute"
      route="{{route}}"
      active="{{forPageActive}}"
      data="{{forPageRouteData}}"
    ></app-route>

    <app-route
      pattern="/customers/:key"
      id="customerPageRoute"
      route="{{route}}"
      active="{{customerPageActive}}"
      data="{{customerPageRouteData}}"
    ></app-route>

    <app-route
      pattern="/features/:key"
      id="featurePageRoute"
      route="{{route}}"
      active="{{featurePageActive}}"
      data="{{featurePageRouteData}}"
    ></app-route>


    <!-- #=== APP VIEWS (FROM CMS PAGES) ===# -->

    <bl-view-web-page
      id="webHomeView"
      active="{{webHomeViewActive}}"
      cms-key="home"
      width-breakpoint="[[widthBreakpoint]]"
      current-user="[[currentUser]]"
      cms-preview-mode="[[cmsPreviewMode]]"
    ></bl-view-web-page>

    <bl-view-web-page
      id="howItWorksView"
      active="{{howItWorksViewActive}}"
      cms-key="how-it-works"
      width-breakpoint="[[widthBreakpoint]]"
      current-user="[[currentUser]]"
      cms-preview-mode="[[cmsPreviewMode]]"
    ></bl-view-web-page>

    <bl-view-web-page
      id="docsView"
      active="{{docsViewActive}}"
      cms-key="docs"
      width-breakpoint="[[widthBreakpoint]]"
      current-user="[[currentUser]]"
      cms-preview-mode="[[cmsPreviewMode]]"
    ></bl-view-web-page>

    <bl-view-web-page
      id="forPageView"
      active="{{forPageActive}}"
      cms-key="[[forPageRouteData.key]]"
      width-breakpoint="[[widthBreakpoint]]"
      cms-path="for"
      current-user="[[currentUser]]"
      cms-preview-mode="[[cmsPreviewMode]]"
    ></bl-view-web-page>

    <bl-view-web-page
      id="customerPageView"
      active="{{customerPageActive}}"
      cms-key="[[customerPageRouteData.key]]"
      cms-path="customers"
      width-breakpoint="[[widthBreakpoint]]"
      current-user="[[currentUser]]"
      cms-preview-mode="[[cmsPreviewMode]]"
    ></bl-view-web-page>

    <bl-view-web-page
      id="featurePageView"
      active="{{featurePageActive}}"
      cms-key="[[featurePageRouteData.key]]"
      cms-path="features"
      width-breakpoint="[[widthBreakpoint]]"
      current-user="[[currentUser]]"
      cms-preview-mode="[[cmsPreviewMode]]"
    ></bl-view-web-page>

    <!-- #=== APP VIEWS (FROM LOCAL VIEW COMPONENTS) ===# -->

    <bl-view-pricing
      id="pricingView"
      active="{{pricingViewActive}}"
      current-user="[[currentUser]]"
      cms-preview-mode="[[cmsPreviewMode]]"
      title="Badge List Pricing"
    ></bl-view-pricing>

    <bl-view-privacy-policy
      id="privacyPolicyView"
      active="{{privacyPolicyViewActive}}"
      current-user="[[currentUser]]"
      cms-preview-mode="[[cmsPreviewMode]]"
      title="Privacy Policy - Badge List"
    ></bl-view-privacy-policy>

    <bl-view-terms-of-service
      id="termsOfServiceView"
      active="{{termsOfServiceViewActive}}"
      current-user="[[currentUser]]"
      cms-preview-mode="[[cmsPreviewMode]]"
      title="Terms of Service - Badge List"
    ></bl-view-terms-of-service>

    
    <!-- #=== TOAST CONTAINER ===# -->
    <div id="toastContainer"></div>

  </template>

  <script>
    class BlWebsite extends Polymer.Element {
      static get is() { return 'bl-website'; }

      static get properties() {
        return {
          
          /** The manifest is required from the backend. It contains details of the logged in user and a CSRF token to use for forms. */
          manifest: {
            type: Object,
            observer: '_manifestChanged'
          },

          /** Automatically set to the current user from the manifest. */
          currentUser: {
            type: Object,
            notify: true
          },

          /** Stores a reference to the CMS client. */
          cmsClient: {
            type: Object,
            notify: true,
          },
          
          cmsPreviewMode: Boolean,

          /** Stores a link to the currently active view component. Managed automatically by the view mixin code. */
          activeView: Object,

          /** 
           * Set this to change the window location hash. Observe this to be notified whenever the location hash changes. 
           * Do not include the hash sign, just the url-safe string to be placed after the hash sign.
           * Setting the Value: `this.website.locationHashKey = 'test-value';`
           * Clearing the Value: `this.website.locationHashKey = '';`
           */
          locationHashKey: {
            type: String,
            notify: true,
            observer: '_locationHashKeyChanged',
            value: function() { return window.location.hash.replace('#', ''); }
          },

          /** True if Intercom is being used and has booted. */
          intercomLoaded: {
            type: Boolean,
            value: false,
            notify: true,
          },

          indexRouteActive: Boolean,
          webRouteActive: Boolean,
          webHomeViewActive: {
            type: Boolean,
            computed: '_webHomeViewActive(indexRouteActive, webRouteActive)',
          },

          /**
           * Contains the breakpoint of the current document width:
           * - (width < 480px) ==> 0
           * - (480px <= width < 840px) ==> 1
           * - (840px <= width < 1200px) ==> 2
           * - (1200px <= width) ==> 3
           */
          widthBreakpoint: {
            type: Number, 
            value: 0,
            notify: true,
          },

          widthBreakpointList: {
            type: Array,
            readOnly: true,
            value: () => {
              return [0, 480, 840, 1200];
            },
          }

        };
      }

      // #=== PUBLIC ACTION METHODS ===#

      /** Displays new toast item in the app toast container. Leave type or autoCloseAfter blank to use the default. */
      addToast(text, type, autoCloseAfter) {
        var newToast = document.createElement('bl-toast');
        newToast.text = text;
        newToast.type = type;
        if (autoCloseAfter != undefined) newToast.autoCloseAfter = autoCloseAfter;
        this.$.toastContainer.appendChild(newToast);
      }

      /** 
       * Sets the `hidden` flag on the intercom container element if it exists.
       * If the intercom container does not exist, then this method does nothing.
       */
      hideIntercom() {
        if (document.querySelector('#intercom-container')) {
          document.querySelector('#intercom-container').hidden = true;
        }
      }

      /** 
       * Clears the `hidden` flag on the intercom container element if it exists.
       * If the intercom container does not exist, then this method does nothing.
       */
      showIntercom() {
        if (document.querySelector('#intercom-container')) {
          document.querySelector('#intercom-container').hidden = false;
        }
      }

      // #=== LIFECYCLE EVENTS ===#

      connectedCallback() {
        if (super.connectedCallback) super.connectedCallback();

        // Add listener for window location hash change
        window.addEventListener('hashchange', e => this._windowLocationHashChanged(e));

        // Initialize width breakpoint and listen for future window resize events
        this._windowResize();
        window.addEventListener('resize', e => this._windowResize(e));
      }

      ready() {
        if (super.ready) super.ready();

        // Remove `loading` class from the body.
        document.getElementsByTagName('body')[0].classList.remove('loading');

        // Listen for Intercom boot
        // Wait for Intercom to load (max 30 seconds)
        const timeout = setTimeout(() => clearInterval(interval), 30000);
        const interval = setInterval(() => {
          if (('Intercom' in window) && window.Intercom.booted && document.querySelector('#intercom-container')) {
            // Intercom is booted!
            clearInterval(interval);
            clearTimeout(timeout);

            if (this.activeView && this.activeView.noChat) this.hideIntercom();
            this.set('intercomLoaded', true);
          }
        }, 100);
      }

      // #=== LISTENER & OBSERVER METHODS ===#

      _manifestChanged(newValue, oldValue) {
        if (newValue) {
          // Initialize the Contentful CMS client
          var contentfulOptions = {
            space: newValue.cms.space_id,
            accessToken: newValue.cms.token,
          };
          if (newValue.cms.preview_token && newValue.cms.preview_token.length) {
            if (sessionStorage.getItem('cmsPreviewMode') == 'on') {
              this.cmsPreviewMode = 'on';
              contentfulOptions.accessToken = newValue.cms.preview_token;
              contentfulOptions.host = 'preview.contentful.com';
            } else {
              this.cmsPreviewMode = 'off';
              sessionStorage.setItem('cmsPreviewMode', 'off');
            }
          } else {
            sessionStorage.removeItem('cmsPreviewMode');
            this.cmsPreviewMode = null;
          }
          this.set('cmsClient',  contentful.createClient(contentfulOptions));

          this.setProperties({
            currentUser: newValue.current_user
          });

          if (newValue.toast && newValue.toast.length) {
            newValue.toast.forEach(function(toastItem) {
              this.addToast(toastItem.text, toastItem.type)
            }.bind(this));
          }
        }
      }

      /** Copies the window location hash to the locationHashKey component property. */
      _windowLocationHashChanged(event) {
        var newHashKey = window.location.hash.replace('#', '');
        if (this.locationHashKey != newHashKey)
          this.locationHashKey = newHashKey;
      }

      _windowResize(e) {
        var currentWidth = window.innerWidth;
        var currentBreakpoint = null;

        for (var i = 0; i < this.widthBreakpointList.length; i++) {
          if (currentWidth >= this.widthBreakpointList[i]) currentBreakpoint = i;
        }

        if (this.widthBreakpoint != currentBreakpoint) this.widthBreakpoint = currentBreakpoint;
      }

      /** Copies the locationHashKey component property to the window location. */
      _locationHashKeyChanged(newValue, oldValue) {
        if (window.location.hash != newValue)
          window.location.hash = newValue;
      }

      // #=== PROPERTY COMPUTER METHODS ===#

      _webHomeViewActive(indexRouteActive, webRouteActive) {
        return indexRouteActive || webRouteActive;
      }

    }

    window.customElements.define(BlWebsite.is, BlWebsite);
  </script>
</dom-module>
