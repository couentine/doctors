<link rel="import" href="../bl-website/bl-website-component-mixin.html">

<!--
# Badge List View Mixin #
  
All Badge List website views components should extend this mixin. It extends the `bl-website-component-mixin`.
-->
<script>

  BlViewMixin = function(superClass) {
    return class extends BlWebsiteComponentMixin(superClass) {

      static get properties() {
        return {
          
          /* Required unless `cmsKey` is set. Indicates the document title when this view is activated. */
          title: {
            type: String,
            value: 'Badge List',
            observer: '_titleChanged',
          },
          
          /**
           * The current status of the view.
           * Either `inactive`, `loading` or `active`.
           * Call `activate` and `deactivate` methods to change this.
           */
          status: {
            type: String,
            value: 'uninitialized',
            notify: true,
            readOnly: true,
            reflectToAttribute: true,
          },

          /** Set this to true to hide the chat widget. */
          noChat: {
            type: Boolean,
            value: false,
          },

          /** 
          * Setting active to `true` will activate the view. Setting active to `false` has no direct effect.
          * The intended way to use this property is to bind this property to the `active` property of a corresponding `<app-route>` 
          * component in `<bl-app>`.
          */
          active: {
            type: Boolean,
            observer: '_activeChanged',
          },

          /**
           * Set this to the slug of this page in the Contentful CMS.
           * It is used to query the content delivery API and set `content`.
           * Note: The `documentTitle` specified in the `content` will automatically override the `title` property if set.
           */
          cmsKey: String,
          
          /**
           * Optional modifier for `cmsKey`. Specifies the value of `landingPagePath` which is used to filter the CMS page.
           * If there is a CMS page with `slug == cmsKey` but `landingPagePath != cmsPath` then the page is returned as not found.
           * Defaults to 'none'.
           */
          cmsPath: {
            type: String,
            value: 'none',
          },

          /** Returns null if `cmsKey` is blank. Otherwise returns `pending`, `loaded`, or `error`. */
          cmsStatus: {
            type: String,
            readOnly: true,
          },

          /** If there is an error retrieving content from the CMS, this returns a one sentence, user-facing error message. */
          cmsErrorMessage: {
            type: String,
            readOnly: true,
          },

          /**
           * For pages which are pulled from the CMS, this is the CMS content retrieved for the specified `cmsKey`.
           */
          content: {
            type: Object,
            value: () => { return {} },
          },

          _timer: Object,

        };
      }

      // #=== PUBLIC ACTION METHODS ===#

      /** 
       * Deactivates the `activeView` in `<bl-website>`, then activates this view and sets it as the active view.
       * Override this method in order to add special logic (such as resetting page state) when the page is activated.
       * Note: `<bl-backend-*>` components which are set to auto load will reload themselves whenever the status goes to active. 
       * If you need to reset page state before the backend reload fires then you can should set the `status` to `loading` which will
       * start the visual transition without triggering a network reload. Then set the `status` to `active` when everything is ready.
       */
      activate() {
        if (!this.website.activeView || (this.website.activeView.id != this.id)) {
          this._setStatus('active');
          if (this.website.activeView) this.website.activeView.deactivate();
          document.title = this.title;
          this.website.activeView = this;

          (this.noChat
            ? this.website.hideIntercom
            : this.website.showIntercom
          )();
        }
      }

      /** 
       * The `<bl-website>` component will fire this method to display the page when the route is navigated away from.
       * Override this method in order to add special logic when the page is de-activated.
       */
      deactivate() {
        if (this._timer) clearTimeout(this._timer);
        this._setStatus('inactive');
      }

      // #=== LIFECYCLE EVENTS ===#

      connectedCallback() {
        if (super.connectedCallback) super.connectedCallback();

        this.website.addEventListener('cms-client-changed', (e) => this._cmsClientChanged(e));
      }

      // #=== LISTENER & OBSERVER METHODS ===#

      _cmsClientChanged(e) {
        if (this.cmsKey && this.website.cmsClient) {
          this.website.cmsClient.getEntries({
            'content_type': 'page',
            'fields.slug': this.cmsKey,
            'fields.landingPagePath': this.cmsPath,
            include: 10,
          }).then((entries) => {
            if (entries && entries.items.length) {
              this.setProperties({
                content: entries.items[0],
                title: entries.items[0].fields.documentTitle,
              });
              this._setCmsStatus('loaded');
            } else {
              this.title = 'Page Not Found - Badge List';
              this._setCmsErrorMessage('The specified page could not be found. Please check the link and try again.');
              this._setCmsStatus('error');
            }
          }).catch((error) => {
            console.log('There was a problem loading content from the CMS:' + error);
            this.title = 'Error - Badge List';
            this._setCmsErrorMessage('There was a problem communicating with the Badge List server. Please try again later.');
            this._setCmsStatus('error');
          });
        }
      }

      _cmsKeyChanged(newValue, oldValue) {
        if ((newValue != undefined) && (newValue != null)) {
          this._setCmsStatus('pending');
        }
      }

      _titleChanged(newValue, oldValue) {
        if (newValue && (this.status == 'active')) {
          document.title = newValue;
          // FIXME >> Temporary test to see if social metadata can be changed after page load...
          document.querySelectorAll('meta[data-key="title"]').forEach((item) => {
            item.content = newValue;
          })
        }
      }

      _activeChanged(newValue, oldValue) {
        if (newValue && !oldValue) {
          this.activate();
        }
      }

      // #=== PUBLIC HELPER & UTILITY METHODS ===#

      /**
       * Use in combination with header panel `expandedPercentage` property.
       * When `expandedPercentage` is `1.0`, returns `expandedValue`.
       * When `expandedPercentage` is `0.0`, returns `collapsedValue`.
       * When `expandedPercentage` is between 1 and 0, returns value from linear distribution between `expandedValue` and `collapsedValue`.
       */
      linearExpansionValue(expandedValue, collapsedValue, expandedPercentage) {
        if ((expandedPercentage == undefined) || (expandedPercentage == null))
          return expandedValue;
        else
          return collapsedValue + ((expandedValue - collapsedValue) * expandedPercentage);
      }

    }
  }

</script>