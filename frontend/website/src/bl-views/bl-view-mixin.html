<link rel="import" href="../bl-website/bl-website-component-mixin.html">

<!--
# Badge List View Mixin #
  
All Badge List website views components should extend this mixin. It extends the `bl-website-component-mixin`.
-->
<script>

  BlViewMixin = function(superClass) {
    return class extends BlWebsiteComponentMixin(superClass) {

      static get properties() {
        return {
          
          /**
           * The current status of the view.
           * Either `inactive`, `loading` or `active`.
           * Call `activate` and `deactivate` methods to change this.
           */
          status: {
            type: String,
            value: 'uninitialized',
            notify: true,
            readOnly: true,
            reflectToAttribute: true
          },

          /** 
          * Setting active to `true` will activate the view. Setting active to `false` has no direct effect.
          * The intended way to use this property is to bind this property to the `active` property of a corresponding `<app-route>` 
          * component in `<bl-website>`.
          */
          active: {
            type: Boolean,
            observer: '_activeChanged'
          },

          /** The href of the new group button. Changes based on whether the user is logged in. */
          createGroupPath: {
            type: String,
            computed: '_createGroupPath(currentUser)',
            value: '/users/sign_up'
          }

        };
      }

      // #=== PUBLIC ACTION METHODS ===#

      /** 
       * Deactivates the `activeView` in `<bl-website>`, then activates this view and sets it as the active view.
       * Override this method in order to add special logic (such as resetting page state) when the page is activated.
       * Note: `<bl-backend-*>` components which are set to auto load will reload themselves whenever the status goes to active. 
       * If you need to reset page state before the backend reload fires then you can should set the `status` to `loading` which will
       * start the visual transition without triggering a network reload. Then set the `status` to `active` when everything is ready.
       */
      activate() {
        if (!this.website.currentView || (this.website.currentView.id != this.id)) {
          this._setStatus('active');
          if (this.website.currentView) this.website.currentView.deactivate();
          this.website.currentView = this;
        }
      }

      showIntercom() {
        if (Intercom) {
          Intercom('show');
        }
      }

      /** 
       * Call this in order to attempt hiding the intercom UI. Runs recursively every 100 milliseconds waiting for the intercom container
       * to show up.
       *
       * @param {number} remainingTryCount - How many attempts should be made? Defaults to 100.
       */
      tryToHideIntercom(remainingTryCount) {
        if (!remainingTryCount) remainingTryCount = 100;

        if (document.querySelector('#intercom-container'))
          document.querySelector('#intercom-container').hidden = true;
        else if (remainingTryCount > 0)
          setTimeout(function() {
            this.tryToHideIntercom(remainingTryCount - 1); 
          }.bind(this), 100);
      }

      /** 
       * The `<bl-website>` component will fire this method to display the page when the route is navigated away from.
       * Override this method in order to add special logic when the page is de-activated.
       */
      deactivate() {
        this._setStatus('inactive');
      }

      // #=== LISTENER & OBSERVER METHODS ===#

      _activeChanged(newValue, oldValue) {
        if (newValue && !oldValue)
          this.activate();
      }

      // #=== PROPERTY COMPUTER METHODS ===#
      
      _createGroupPath(currentUser) {
        if (currentUser && currentUser.username)
          return '/groups/new';
        else
          return '/users/sign_up';
      }

      // #=== PUBLIC HELPER & UTILITY METHODS ===#

      /**
       * Use in combination with header panel `expandedPercentage` property.
       * When `expandedPercentage` is `1.0`, returns `expandedValue`.
       * When `expandedPercentage` is `0.0`, returns `collapsedValue`.
       * When `expandedPercentage` is between 1 and 0, returns value from linear distribution between `expandedValue` and `collapsedValue`.
       */
      linearExpansionValue(expandedValue, collapsedValue, expandedPercentage) {
        if ((expandedPercentage == undefined) || (expandedPercentage == null))
          return expandedValue;
        else
          return collapsedValue + ((expandedValue - collapsedValue) * expandedPercentage);
      }

    }
  }

</script>