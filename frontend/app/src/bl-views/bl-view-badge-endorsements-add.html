<!-- #=== POLYMER & SHIMS ===# -->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- #=== STANDARD POLYMER COMPONENTS ===# -->
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu-light.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<!-- #=== BADGE LIST COMPONENTS ===# -->
<link rel="import" href="../bl-backend/bl-backend-importer.html">
<link rel="import" href="../bl-input/bl-fab.html">
<link rel="import" href="../bl-input/bl-input-rich-text.html">
<link rel="import" href="../bl-input/bl-input-text.html">
<link rel="import" href="../bl-input/bl-input-textarea.html">
<link rel="import" href="bl-header-nav-left.html">
<link rel="import" href="bl-header-nav-right.html">
<link rel="import" href="bl-header-panel.html">
<link rel="import" href="bl-view-mixin.html">

<!--
# Badge List Bulk Add Badge Endorsements View #

Interface for bulk awarding badges. Only available to groups with the `bulk_tools` feature.
-->
<dom-module id="bl-view-badge-endorsements-add">
  <template>

    <style include="bl-style-classes">
      
      /* === LAYOUT & BASE STYLES === */
        
        :host {
          display: none;
        }
        :host([status=active]) {
          display: block;
        }

      /* === HEADER PANEL STYLES === */

        bl-header-panel {
          background: var(--bl-purple-50);
        }
        bl-header-panel.hasItems_true {
          background: white;
        }
          #expandedBackground {
            border-bottom: 4px solid var(--bl-purple-400);
            background: linear-gradient(90deg, var(--bl-purple-500), var(--bl-purple-700));
          }
          #condensedBackground {
            border-bottom: 4px solid var(--bl-purple-400);
            background: linear-gradient(90deg, var(--bl-purple-500), var(--bl-purple-700));
          }
            .headerBackgroundImage {
              position: absolute;
              top: 1em; right: 1em; bottom: 0; left: 40%;
              background-image: url('../../images/ivory-mountiain-trophy.png');
              background-repeat: no-repeat;
              background-position: 100% 100%; 
              background-size: contain;
            }
          #content {
            color: var(--bl-grey-800);
          }
          #footer {
            background: transparent;
          }
          
          #leftNav {
            display: block;
            text-align: left;
            position: absolute;
            top: 0;
            right: 4em;
            bottom: 4px;
            left: 0;
            padding: 2em;
            
            font-size: 0.8rem;
            line-height: 1em;
          }
          @media (min-width: 480px) {
            #leftNav { font-size: 1rem; }
          }
            #headerImageWrapper {
              float: left;
              height: 100%;
              width: 5.7em;
              margin-right: 0.8em;
              display: flex;
              flex-direction: column;
              justify-content: center;
            }
              #headerImage { 
                width: 100%;
              }
            #headerText {
              display: flex;
              flex-direction: column;
              justify-content: center;
              height: 100%;
              color: white;
            }
              #subtitle {
                font-size: 1.5em;
                line-height: 1.6em;
                font-weight: 400;
              }
              #title {
                display: block;
                font-size: 3em;
                line-height: 1.1em;
                margin: 0;
                font-weight: 600;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                padding-bottom: 0.15em;
                text-shadow: 0 0 2px var(--bl-grey-500); /* provides contrast against header background image */
              }

          #rightNav {
            display: block;
            position: absolute;
            top: 0;
            right: 0;
            bottom: 4px;
            width: 4em;
            padding: 0;
            text-align: right;
          }
            #rightNav a, #rightNav a:visited {
              display: block;
              padding: 0.8rem;
              font-size: 2.3em;
              color: white;
              text-decoration: none;
            }

      /* === SHARED CONTENT STYLES === */

        .contentBlock {
          margin: 3em auto;
          max-width: 40rem;
          padding: 0 2em;
          color: var(--bl-grey-700);
        }
        
          .sectionHeader {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 1.5rem;
          }

          .optionButtons {
            display: block;
            margin: 0;
            padding: 0 1px;
            list-style: none;
            border-radius: 9px;
            background: var(--bl-orange-500);

            @apply --bl-shadow-3;
          }
            .optionButtons>li {
              display: block;
              border-bottom: 1px solid var(--bl-orange-400);
            }
            .optionButtons>li:last-child {
              border-bottom: none;
            }
              .optionButtons>li>a {
                display: flex;
                align-items: center;
                color: var(--bl-orange-50);
                text-decoration: none;
                padding: 1em;
              }
                .optionButtons>li>a>i {
                  font-size: 1.5em;
                  margin-right: 0.5rem;
                }
                .optionButtons>li>a>span {
                  font-size: 1.1em;
                }

      /* === DIALOGS === */

        paper-dialog {
          --bl-dialog-gradient-color1: var(--bl-purple-500);
          --bl-dialog-gradient-color2: var(--bl-orange-500);
        }
      
      /* === TABLE PANEL === */

        #tablePanel {
          padding: 0;
          background: white;
        }

          #tableFooter {
            position: fixed;
            
            right:   0;
            bottom:  0;
            left:    0;

            color:          var(--bl-grey-500);
            background:     var(--bl-grey-200);
            border:         none;

            z-index: 100;
            overflow: hidden;
            @apply --bl-shadow-4;
          }
            #tableFooter > .divider {
              height: 0.2rem;
              border-bottom: 1px solid var(--bl-grey-300);
            }
            #tableFooter > .ring {
              position: absolute;
              border-radius: 100%;
            }
            #tableFooter > .ring.inner {
              height: 6rem;
              width: 6rem;

              top: -4.1rem;
              right: -0.1rem;

              background: var(--bl-orange-100);
              border: 1rem solid var(--bl-orange-200);
              opacity: 0.3;
              z-index: 1;
            }
            #tableFooter > .ring.divider {
              width: 10rem;
              top: 0;
              right: 0;

              background: transparent;
              border-bottom: 1px solid var(--bl-grey-300);
              border-radius: 0;
              z-index: 1;
            }
            #tableActions {
              list-style: none;
              margin: 0;
              padding: 0;
              display: flex;
              justify-content: left;
            }
            @media(min-width: 480px) {
              #tableActions {
                justify-content: center;
              }
            }
              #tableActions > li {
                display: block;
                margin: 0.5em;
              }
                #tableActions > li > paper-button {
                  min-width: 0;
                }

          #tableContent {
            padding-bottom: 5rem;
            overflow-x: scroll;
          }
            #tableContent table {
              width: 100%;
              border-collapse: collapse;
            }
              #tableContent table tr th {
                font-size: 0.8em;
                padding: 1em 0.7em;
                
                text-transform: uppercase;

                color: var(--bl-purple-800);
                background: var(--bl-purple-50);
                border-top: 1.5px solid var(--bl-purple-100);
                border-bottom: 1.5px solid var(--bl-purple-100);
              }
              #tableContent table tr td {
                padding: 0.3em 0.7em;
                text-align: center;
                border-bottom: 1px solid var(--bl-grey-100);
                background: white;
              }
              #tableContent table tr td.firstColumn {
                text-align: left;
              }
                #tableContent table tr td pre {
                  font-family: 'Roboto Mono';
                  font-size: 0.6em;
                  max-width: 30em;
                  white-space: pre-wrap;
                  padding: 0.2em;
                  margin: 0.5rem auto;
                 
                  border-radius: 3px;
                  border: 1px solid var(--bl-grey-200);
                  background: var(--bl-grey-50);
                  box-shadow: inset -1px 0px 2px rgba(0,0,0,0.05);

                  max-height: 10.4em;
                  overflow-y: hidden;
                  transition: 0.5s all;
                }
                #tableContent table tr td pre:hover, #tableContent table tr td pre:focus {
                  max-height: 30em;
                }
              #tableContent table tr.failed td {
                background: var(--bl-red-50);
              }

    </style>

    <!-- #=== BACKEND LINKS ===# -->

    <bl-backend-importer id="importer" model="endorsement" parent-model="badge" parent-key="[[badge.id]]" target="{{endorsements}}"
      parameters="{{importerParameters}}" ></bl-backend-importer>

    <!-- #=== HEADER PANEL ===# -->

    <bl-header-panel id="headerPanel" expanded-height="10" condensed-height="3.5" expanded-percentage="{{expandedPercentage}}"
        class$="hasItems_[[hasItems]]" current-user="[[currentUser]]">
      <div id="expandedBackground" slot="expandedBackground">
        <div class="headerBackgroundImage"></div>
      </div>
      <div id="condensedBackground" slot="condensedBackground">&nbsp;</div>

      <div id="leftNav" slot="leftNav" style$="padding: [[leftNavPaddingEm]]em;">
        <div id="headerImageWrapper" style$="width: [[headerImageSizeEm]]em;">
          <img id="headerImage" src$="[[badge.attributes.image_url]]">
        </div>
        <div id="headerText">
          <div id="subtitle" style$="font-size: [[subtitleFontSizeEm]]em;">Bulk Endorse</div>
          <h1 id="title" style$="font-size: [[titleFontSizeEm]]em;">[[badge.attributes.name]]</h1>
        </div>
      </div>
      <div id="rightNav" slot="rightNav">
        <a href$="[[badge.links.self_web]]" style$="font-size: [[rightNavFontSizeEm]]em;">
          <i class="icon-cross"></i>
        </a>
      </div>

      <div id="footer" slot="footer">&nbsp;</div>

      <div id="content" slot="content">

        <!-- #=== BLANK PANEL ===# -->

        <div id="blankPanel" hidden="[[hasItems]]">
          <div class="contentBlock">
            <p>
              This tool allows you to create badge portfolio items for many people at a time, even if they are not yet a member of your 
              Badge List group. To use this tool you will need to build a list of portfolio items. Each portfolio item can be either
              an endorsement or a piece of evidence.
            </p>
          </div>

          <div class="contentBlock">
            <div class="sectionHeader">
              To add new portfolio items you have three options:
            </div>

            <ul class="optionButtons">
              <li>
                <a href="#" on-tap="loadCSV">
                  <i class="icon-file-spreadsheet"></i>
                  <span>Add items from a CSV file</span>
                </a>
              </li>
              <li>
                <a href="#" on-tap="pasteEmails">
                  <i class="icon-paste"></i>
                  <span>Copy &amp; paste a list of email addresses</span>
                </a>
              </li>
              <li>
                <a href="#" on-tap="newItem">
                  <i class="icon-edit"></i>
                  <span>Type in items one at a time</span>
                </a>
              </li>
            </ul>
          </div>
        </div>

        <!-- #=== TABLE PANEL ===# -->

        <div id="tablePanel" hidden="[[!hasItems]]">
          <div id="tableFooter">
            <div class="divider">&nbsp;</div>
            <div class="ring inner">&nbsp;</div>
            <div class="ring divider">&nbsp;</div>

            <ul id="tableActions">
              <li>
                <paper-button on-tap="loadCSV" class="transparent">
                  <i class="icon-file-spreadsheet"></i>
                  <span>
                    <span class="showAt840">Load</span> 
                    <span class="showAt480">CSV</span>
                  </span>
                </paper-button>
              </li>
              <li>
                <paper-button on-tap="pasteEmails" class="transparent">
                  <i class="icon-paste"></i>
                  <span>
                    <span class="showAt480">Paste</span>
                    <span class="showAt840">Emails</span>
                  </span>
                </paper-button>
              </li>
              <li>
                <paper-button class="transparent" on-tap="newItem">
                  <i class="icon-plus"></i>
                  <span class="showAt480">Type</span>
                  <span class="showAt840">New Item</span>
                </paper-button>
              </li>
            </ul>
          </div>

          <div id="tableContent">
            <table>
              <thead>
                <tr>
                  <th></th>
                  <th>Email</th>
                  <th>Summary</th>
                  <th class="showAt480">Body</th>
                  <th class="showAt480">Requirement</th>
                  <th class="showAt480">Format</th>
                </tr>
              </thead>
              <tbody>
                <template is="dom-repeat" items="[[endorsements.itemsToImport]]">
                  <tr class$="[[item.backend.status.code]]">
                    <td class="firstColumn">
                      <paper-button class="transparent borderless narrow" on-tap="selectItem">
                        <i class="icon-warning-circle red" hidden="[[!item.backend.status.isFailed]]"></i>
                        <i class="icon-pencil"></i>
                      </paper-button>
                    </td>
                    <td>[[item.attributes.email]]</td>
                    <td>[[item.attributes.summary]]</td>
                    <td class="showAt480">
                      <pre hidden="[[!item.attributes.body]]">[[item.attributes.body]]</pre>
                    </td>
                    <td class="showAt480">[[item.attributes.requirement]]</td>
                    <td class="showAt480">[[item.attributes.format]]</td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <!-- #=== IMPORT FAB ===# -->

        <bl-fab id="importFab" icon-class="icon-cloud-upload" class="fixed orange" label="Import" on-button-press="openStartImportDialog" 
          active="[[hasItems]]"></bl-fab>

      </div>
    </bl-header-panel>

    <!-- #=== EDIT ITEM DIALOG ===# -->

    <paper-dialog id="editItemDialog" class="orange dialog-gradients" modal dynamic-align>
      <h2 hidden="[[!selectedItemIsNew]]">Add Item</h2>
      <h2 hidden="[[selectedItemIsNew]]">Edit Item</h2>
      <div class="dialogIcon">
        <i class="icon-register"></i>
      </div>
            
      <paper-dialog-scrollable>
        <iron-form id="editItemForm">
          <form>
            <p hidden="[[!endorsements.selectedItem.backend.status.isFailed]]" class="error">
              <i class="icon-warning-circle"></i>
              <span>
                This item could not be saved in the last import. 
                Error Message: [[endorsements.selectedItem.backend.status.errorMessage]].
              </span>
            </p>

            <bl-input-text id="selectedItemEmail" label="Email" format="email" value="{{endorsements.selectedItem.attributes.email}}"
              class="orange" autofocus>
            </bl-input-text>
            <bl-input-text id="selectedItemSummary" label="Summary" value="{{endorsements.selectedItem.attributes.summary}}"
              class="orange">
            </bl-input-text>
            <bl-input-rich-text id="selectedItemBody" label="Body" value="{{endorsements.selectedItem.attributes.body}}"
              class="orange" bounding-element="[[getElement('editItemDialog')]]">
            </bl-input-rich-text>
            <bl-input-text id="selectedItemRequirement" label="Post as Evidence to Requirement"
              value="{{endorsements.selectedItem.attributes.requirement}}" class="orange">
            </bl-input-text>
            <bl-input-text id="selectedItemFormat" label="Evidence Format"
              value="{{endorsements.selectedItem.attributes.format}}" class="orange">
            </bl-input-text>
          </form>
        </iron-form>
      </paper-dialog-scrollable>

      <div class="buttons">
        <div class="left" hidden="[[selectedItemIsNew]]">
          <paper-button class="orange transparent borderless narrow whiteText" on-tap="previousItem" disabled="[[selectedItemIsFirst]]">
            <i class="icon-chevron-left"></i>
          </paper-button>
          <paper-button class="orange transparent borderless narrow whiteText" on-tap="nextItem" disabled="[[selectedItemIsLast]]">
            <i class="icon-chevron-right"></i>
          </paper-button>
        </div>

        <paper-button class="orange transparent borderless" on-tap="removeItem" dialog-dismiss hidden="[[!selectedItemIsNew]]">
          <i class="icon-cross"></i> Cancel
        </paper-button>
        <paper-button class="orange transparent borderless" on-tap="removeItem" dialog-dismiss hidden="[[selectedItemIsNew]]">
          <i class="icon-trash"></i> Delete
        </paper-button>

        <paper-button class="orange primary" on-tap="saveItem" dialog-confirm>
          Save
        </paper-button>
      </div>
    </paper-dialog>

    <!-- #=== PASTE EMAILS DIALOG ===# -->

    <paper-dialog id="pasteEmailsDialog" class="orange dialog-gradients" modal dynamic-align>
      <h2>Paste List of Emails</h2>
      <div class="dialogIcon">
        <i class="icon-paste"></i>
      </div>
            
      <paper-dialog-scrollable>
        <iron-form id="pasteEmailsForm">
          <form>
            <p>
              <strong>Paste a list of email addresses separated by commas or each on their own line.</strong>
            </p>

            <bl-input-textarea id="buildItemsEmails" label="List of Emails" value="{{buildItemsEmails}}" class="orange" autofocus
              rows="5"></bl-input-textarea>
            <bl-input-text id="buildItemsSummary" label="Summary" value="{{buildItemsSummary}}"
              class="orange">
            </bl-input-text>
            <bl-input-rich-text id="buildItemsBody" label="Body" value="{{buildItemsBody}}"
              class="orange" bounding-element="[[getElement('pasteEmailsDialog')]]">
            </bl-input-rich-text>
            <bl-input-text id="selectedItemRequirement" label="Post as Evidence to Requirement"
              value="{{endorsements.selectedItem.attributes.requirement}}" class="orange">
            </bl-input-text>
            <bl-input-text id="selectedItemFormat" label="Evidence Format"
              value="{{endorsements.selectedItem.attributes.format}}" class="orange">
            </bl-input-text>
          </form>
        </iron-form>
      </paper-dialog-scrollable>

      <div class="buttons">
        <paper-button class="orange transparent borderless" dialog-dismiss>
          <i class="icon-cross"></i> Cancel
        </paper-button>
        <paper-button class="orange primary" on-tap="buildItems">
          Save
        </paper-button>
      </div>
    </paper-dialog>

    <!-- #=== CSV FILE DIALOG ===# -->

    <paper-dialog id="csvFileDialog" class="orange dialog-gradients" modal dynamic-align>
      <h2>Import CSV File</h2>
      <div class="dialogIcon">
        <i class="icon-file-spreadsheet"></i>
      </div>
            
      <paper-dialog-scrollable>
        <iron-form id="csvFileForm">
          <form>
            <p>
              <strong>Click the &ldquo;Select a File&rdquo; button below to import a file from your computer.</strong>
            </p>
            <small>
              <p>
                To use this tool you will first need to build a CSV file with up to five columns: Email, Summary, Body, Requirement and
                Format. This is an advanced tool which can take some work to figure out when using it for the first time.
              </p>
              <p>
                Please check out the resources below and email us at <a href="mailto:help@badgelist.com">help@badgelist.com</a> if you'd
                like assistance.
              </p>
              <p>Helpful Resources:</p>
            </small>
            <ul class="small">
              <li>
                <a href$="[[appPath('link.bulkAwardTutorialVideo', app)]]" target="_blank">3 Minute Tutorial Video on Bulk Endorsing</a>.
              </li>
              <li>
                <a href$="[[appPath('template.bulkAwardingCsv', app)]]">Download Bulk Endorsement CSV template</a>.
              </li>
              <li>
                <a href$="[[appPath('link.csvTutorial', app)]]" target="_blank">Tutorial: How to build a CSV file</a>.
              </li>
            </ul>
            <input id="csvFileInput" accept=".csv" type="file" hidden>
          </form>
        </iron-form>
      </paper-dialog-scrollable>

      <div class="buttons">
        <paper-button class="orange transparent borderless" dialog-dismiss>
          <i class="icon-cross"></i> Nevermind
        </paper-button>
        <paper-button class="orange primary" on-tap="selectCSVFile" dialog-confirm>
          <i class="icon-file-magnifier"></i> Select a File
        </paper-button>
      </div>
    </paper-dialog>

    <!-- #=== IMPORTER PARSING DIALOG ===# -->

    <paper-dialog id="importerParsingDialog" class="orange no-title-bar" modal dynamic-align>
      <h2>Processing CSV File...</h2>

      <paper-spinner-lite active class="orange"></paper-spinner-lite>
            
      <div class="dialogContent">
        <p>
          Please wait while Badge List processes your CSV file.
        </p>
      </div>
    </paper-dialog>

    <!-- #=== IMPORTER MAPPING DIALOG ===# -->

    <paper-dialog id="importerMappingDialog" class="purple dialog-gradients" modal dynamic-align>
      <h2>Map CSV Columns</h2>
      <div class="dialogIcon">
        <i class="icon-insert-right"></i>
      </div>
            
      <paper-dialog-scrollable>
        <iron-form id="mappingForm">
          <form>
            <p>
              Please select which column headers from your CSV file contain which of the portfolio item fields.
            </p>

            <template is="dom-repeat" items="{{endorsements.csvColumnMap}}" as="csvColumnMapItem">
              <paper-dropdown-menu-light class="purple" label="[[csvColumnMapItem.property]]">
                <paper-listbox slot="dropdown-content" id$="[[csvColumnMapItem.property]]-listbox" attr-for-selected="value" 
                    selected="{{csvColumnMapItem.column}}">
                  <paper-item value="">[None]</paper-item>
                  <template is="dom-repeat" items="[[endorsements.csvColumns]]" as="columnName">
                    <paper-item value="[[columnName]]">[[columnName]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu-light>
            </template>
          </form>
        </iron-form>
      </paper-dialog-scrollable>

      <div class="buttons">
        <paper-button class="purple transparent borderless" on-tap="cancelMapping" dialog-dismiss>
          <i class="icon-cross"></i> Cancel
        </paper-button>
        <paper-button class="purple primary" on-tap="finishMapping" dialog-confirm>
          <i class="icon-check"></i> Finish Loading Items
        </paper-button>
      </div>
    </paper-dialog>

    <!-- #=== START IMPORT DIALOG ===# -->

    <paper-dialog id="startImportDialog" class="orange dialog-gradients" modal dynamic-align>
      <h2>Import Portfolio Items</h2>
      <div class="dialogIcon">
        <i class="icon-cloud-upload"></i>
      </div>
            
      <div class="dialogContent">
        <iron-form id="startImportForm">
          <form>
            <p>
              People who have not yet created Badge List accounts will not be added to the badge until they create their account.
              Until then they will appear under the &ldquo;Invited Members&rdquo; list on the group screen.
            </p>

            <h3>Bulk Award Options</h3>

            <paper-checkbox id="sendEmailsCheckbox" checked="{{importerParameters.send_emails_to_new_users}}" class="orange">
              Send email notifications to new users
              <span class="help-text">
                Existing users will always receive notifications according to their preferences.
              </span>
            </paper-checkbox>
          </form>
        </iron-form>
      </div>

      <div class="buttons">
        <paper-button class="orange transparent borderless" dialog-dismiss>
          <i class="icon-arrow-left"></i> Return to List
        </paper-button>
        <paper-button class="orange primary" on-tap="startImport" dialog-confirm>
          <i class="icon-shield"></i> Start Import
        </paper-button>
      </div>
    </paper-dialog>

    <!-- #=== IMPORTER IMPORTING DIALOG ===# -->

    <paper-dialog id="importerImportingDialog" class="orange no-title-bar" modal dynamic-align>
      <h2>Importing Portfolio Items...</h2>

      <paper-spinner-lite active class="orange"></paper-spinner-lite>
            
      <div class="dialogContent">
        <p>
          Importing Batch [[endorsements.status.currentBatch]] of [[endorsements.status.batchCount]]
          ([[endorsements.status.poller.progress]]%)
        </p>
      </div>
    </paper-dialog>

    <!-- #=== IMPORTER ERROR DIALOG ===# -->

    <paper-dialog id="importerErrorDialog" class="red no-title-bar" modal dynamic-align>
      <h2>Import Error</h2>
      <div class="dialogIcon">
        <i class="icon-shield-warning"></i>
      </div>
            
      <div class="dialogContent">
        <p>
          There was a problem importing your items. Please review the error message below and try again.
        </p>
        <p>
          <strong>Error Message:</strong> [[endorsements.status.errorMessage]]
        </p>
      </div>

      <div class="buttons">
        <paper-button class="red primary" dialog-dismiss>
          Close
        </paper-button>
      </div>
    </paper-dialog>

    <!-- #=== IMPORTER RESULTS DIALOG ===# -->

    <paper-dialog id="importerResultsDialog" class="purple dialog-gradients" modal dynamic-align>
      <h2>Import Complete</h2>
      <div class="dialogIcon">
        <i class="icon-cloud-check"></i>
      </div>

      <div class="dialogContent">
        <p>
          <strong>Successfully Imported Items:</strong> [[endorsements.status.importedItemCount]]
        </p>
        <p>
          <strong>Failed Items:</strong> [[endorsements.status.failedItemCount]]
        </p>
        
        <p class="small" hidden="[[!endorsements.status.failedItemCount]]">
          <strong>Note:</strong> 
          If you use the bulk awarding tool to award the same badge multiple times to the same person it will <em>not</em> cause any 
          problems. The second endorsement will simply overwrite the first one. 
          If you enable email notifications, however, the recipient <em>will</em> receive multiple emails.
        </p>
      </div>

      <!-- #=== BUTTON PANEL IF THERE ARE NO FAILED ITEMS ===# -->
      <div class="buttons" hidden="[[endorsements.status.failedItemCount]]">
        <paper-button class="purple transparent borderless" dialog-dismiss>
          <i class="icon-arrow-left"></i> Add More Items
        </paper-button>
        <a class="button" href$="[[badge.links.self_web]]">
          <paper-button class="purple primary" dialog-confirm>
            <i class="icon-arrow-right"></i> Return to Badge
          </paper-button>
        </a>
      </div>
      
      <!-- #=== BUTTON PANEL IF THERE ARE FAILED ITEMS ===# -->
      <div class="buttons" hidden="[[!endorsements.status.failedItemCount]]">
        <paper-button class="purple primary" dialog-dismiss>
          <i class="icon-arrow-left"></i> View Errors
        </paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    class BlViewBadgeEndorsementsAdd extends BlViewMixin(Polymer.Element) {

      static get is() { return 'bl-view-badge-endorsements-add'; }

      static get properties() {
        return {

          group: Object,

          badge: Object,
          
          /** Serves as the target of the `bl-backend-importer`. */
          endorsements: Object,

          /** Used internally to control the current display mode. */
          hasItems: {
            type: Boolean,
            value: false,
            readOnly: true
          },

          /** Used by `buildItems` action. */
          buildItemsEmails: String,

          /** Used by `buildItems` action. */
          buildItemsSummary: String,

          /** Used by `buildItems` action. */
          buildItemsBody: String,
          
          /** Used internally to control the display of the edit item dialog. */
          selectedItemIsNew: {
            type: Boolean,
            readOnly: true
          },
          
          selectedItemIsFirst: {
            type: Boolean,
            computed: '_selectedItemIsFirst(endorsements.selectedItem.uniqueId)'
          },
          
          selectedItemIsLast: {
            type: Boolean,
            computed: '_selectedItemIsLast(endorsements.selectedItem.uniqueId)'
          },

          expandedPercentage: Number,

          leftNavPaddingEm: {
            type: Number,
            computed: '_leftNavPaddingEm(expandedPercentage)'
          },

          headerImageSizeEm: {
            type: Number,
            computed: '_headerImageSizeEm(expandedPercentage)'
          },

          subtitleFontSizeEm: {
            type: Number,
            computed: '_subtitleFontSizeEm(expandedPercentage)'
          },

          titleFontSizeEm: {
            type: Number,
            computed: '_titleFontSizeEm(expandedPercentage)'
          },

          rightNavFontSizeEm: {
            type: Number,
            computed: '_rightNavFontSizeEm(expandedPercentage)'
          },

          _csvColumnMapBackup: Object

        }
      }

      // #=== PUBLIC ACTION METHODS ===#

      /** Adds a new item to the list and shows the edit item dialog. */
      newItem() {
        this.endorsements.addItem();
        this._setSelectedItemIsNew(true);
        this.$.editItemDialog.open();
      }

      /** Navigates to the item before the currently selected item. */
      previousItem() {
        this.endorsements.selectPreviousItem();
      }

      /** Navigates to the item after the currently selected item. */
      nextItem() {
        this.endorsements.selectNextItem();
      }

      /** Opens the paste emails dialog. */
      pasteEmails() {
        this.$.pasteEmailsDialog.open();
      }

      /** 
       * Builds out a list of items using `buildItemsEmails`, `buildItemsSummary` and `buildItemsBody`, then adds the newly built items 
       * to the import list. Note: The list of emails is split by comma, new line, pipe, semi-colon, front/back slash and less/greater than.
       */
      buildItems() {
        var emails;

        if (this.buildItemsEmails && this.buildItemsEmails.length && this.buildItemsEmails.includes('@'))
          emails = this.buildItemsEmails.split(/[,;|\n><\/\\]/).map(function(item) { 
            return item.trim().toLowerCase() 
          }).filter(function(item) {
            return item.length && item.includes('@') 
          });
        
        if (emails && emails.length) {
          var items = emails.map(function(email) {
            return {
              email: email,
              summary: this.buildItemsSummary,
              body: this.buildItemsBody
            }
          }.bind(this));

          this.endorsements.addItemsFromList(items);
          this.$.pasteEmailsDialog.close();
          this.setProperties({
            buildItemsEmails: null,
            buildItemsSummary: null,
            buildItemsBody: null
          });

          if (this.endorsements.itemsToImport.length)
            this._setHasItems(true);
          else
            this._setHasItems(false);
        } else {
          alert('You must enter at least one email address in the list.');
        }
      }
      
      /** Opens the CSV file dialog. */
      loadCSV() {
        this.$.csvFileDialog.open();
      }

      /** Selects the current item. Expects `e.detail.model.item` to point to the item. */
      selectItem(e) {
        if (e && e.model && e.model.item && e.model.item.backend && e.model.item.backend.select) {
          e.model.item.backend.select();
          this._setSelectedItemIsNew(false);
          this.$.editItemDialog.open();
        }
      }

      /** Closes the edit item dialog. */
      saveItem() {
        if (this.endorsements.itemsToImport.length)
          this._setHasItems(true);
        else
          this._setHasItems(false);
        
        this.$.editItemDialog.close();
      }

      /** Deletes the currently selected item and closes the edit item dialog. */
      removeItem() {
        this.endorsements.selectedItem.backend.remove();

        if (this.endorsements.itemsToImport.length)
          this._setHasItems(true);
        else
          this._setHasItems(false);
        
        this.$.editItemDialog.close();
      }

      /** Triggers the hidden `csvFileInput` file input dialog. */
      selectCSVFile() {
        this.$.csvFileInput.click();
      }

      /** Cancels the parsing process from the mapping dialog. */
      cancelMapping() {
        this.endorsements.cancelParsing();
      }

      /** Continues the import process after mapping. */
      finishMapping() {
        if (this.endorsements.status.isMapping) {
          // Workaround for issue with dropdown menus not binding properly
          for (var i = 0; i < this.endorsements.csvColumnMap.length; i++)
            if (!this.endorsements.csvColumnMap[i].column) {
              var element = this.$.mappingForm.querySelector('#' + this.endorsements.csvColumnMap[i].property + '-listbox');
              if (element && element.selected)
                this.set('endorsements.csvColumnMap.' + i + '.column', element.selected);
            }

          this.endorsements.finishMapping();
        }
      }

      openStartImportDialog() {
        this.$.startImportDialog.open();
      }

      /** Starts the import of the current batch of itemsToImport. */
      startImport() {
        this.endorsements.import();
      }

      // #=== LIFECYCLE EVENTS ===#

      connectedCallback() {
        if (super.connectedCallback) super.connectedCallback();

        this.$.csvFileInput.addEventListener('change', e => this._csvFileChanged());
        this.$.importer.addEventListener('csv-parsing-complete', e => this._csvParsingComplete());
        this.$.importer.addEventListener('import-complete', e => this._importComplete());
        this.$.importerMappingDialog.addEventListener('iron-overlay-opened', e => this._importerMappingDialogOpened());
      }

      // #=== LISTENER & OBSERVER METHODS ===#

      static get observers() {
          return [
            '_endorsementsStatusIsErrorChanged(endorsements.status.isError)',
            '_endorsementsStatusIsParsingChanged(endorsements.status.isParsing)',
            '_endorsementsStatusIsMappingChanged(endorsements.status.isMapping)',
            '_endorsementsStatusIsImportingChanged(endorsements.status.isImporting)'
          ]
      }

      _endorsementsStatusIsErrorChanged(endorsementsStatusIsError) {
        if (endorsementsStatusIsError)
          this.$.importerErrorDialog.open();
      }

      _endorsementsStatusIsParsingChanged(endorsementsStatusIsParsing) {
        if (endorsementsStatusIsParsing)
          this.$.importerParsingDialog.open();
        else
          this.$.importerParsingDialog.close();
      }

      _endorsementsStatusIsMappingChanged(endorsementsStatusIsMapping) {
        if (endorsementsStatusIsMapping){
          // The listbox is losing the initial selections when the dialog opens, so as a workaround we will back them up and restore them.
          this._csvColumnMapBackup = this.endorsements.csvColumnMap.map(function(item) {
            return Object.assign({}, item)
          }, {});

          this.$.importerMappingDialog.open();

          this.$.csvFileInput.value = ""; // allows the same file to be selected again
        } else
          this.$.importerMappingDialog.close();
      }

      _endorsementsStatusIsImportingChanged(endorsementsStatusIsImporting) {
        if (endorsementsStatusIsImporting)
          this.$.importerImportingDialog.open();
        else
          this.$.importerImportingDialog.close();
      }

      _csvFileChanged() {
        if (this.$.csvFileInput.files.length)
          this.endorsements.addItemsFromCSV(this.$.csvFileInput.files[0]);
      }

      _csvParsingComplete() {
        if (this.endorsements.itemsToImport.length) {
          this._setHasItems(true);
          this.$.csvFileInput.value = ""; // allows the same file to be selected again
        } else
          this._setHasItems(false);
      }

      _importComplete() {
        this.$.importerResultsDialog.open();

        if (this.endorsements.itemsToImport.length)
          this._setHasItems(true);
        else
          this._setHasItems(false);
      }

      _importerMappingDialogOpened() {
        // Workaround to fix bug where the listbox loses the initial mapping values.
        this._csvColumnMapBackup.forEach(function(item, index) {
          this.set('endorsements.csvColumnMap.' + index + '.column', item.column)
        }.bind(this));
      }

      // #=== PROPERTY COMPUTER METHODS ===#

      _selectedItemIsFirst(selectedItemUniqueId) {
        if (selectedItemUniqueId && this.endorsements.itemsToImport.length) {
          return (selectedItemUniqueId == this.endorsements.itemsToImport[0].uniqueId);
        } else {
          return undefined;
        }
      }

      _selectedItemIsLast(selectedItemUniqueId) {
        if (selectedItemUniqueId && this.endorsements.itemsToImport.length) {
          return (selectedItemUniqueId == this.endorsements.itemsToImport[this.endorsements.itemsToImport.length - 1].uniqueId);
        } else {
          return undefined;
        }
      }

      _leftNavPaddingEm(expandedPercentage) {
        return this.linearExpansionValue(2.0, 0.8, expandedPercentage);
      }

      _headerImageSizeEm(expandedPercentage) {
        return this.linearExpansionValue(5.7, 2.0, expandedPercentage);
      }

      _subtitleFontSizeEm(expandedPercentage) {
        return this.linearExpansionValue(1.5, 0, expandedPercentage);
      }

      _titleFontSizeEm(expandedPercentage) {
        return this.linearExpansionValue(3.0, 1.5, expandedPercentage);
      }

      _rightNavFontSizeEm(expandedPercentage) {
        return this.linearExpansionValue(2.3, 1.5, expandedPercentage);
      }

      // #=== PUBLIC HELPER & UTILITY METHODS ===#

      getElement(elementId) {
        return this.$[elementId];
      }

    }

    window.customElements.define(BlViewBadgeEndorsementsAdd.is, BlViewBadgeEndorsementsAdd);
  </script>
</dom-module>