<!-- #=== POLYMER & SHIMS ===# -->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- #=== BADGE LIST COMPONENTS ===# -->
<link rel="import" href="../bl-app/bl-app-component-mixin.html">

<!--
# Badge List Backend List #

Use this component to bind a local component property with a list endpoint in the Badge List backend.
-->
<dom-module id="bl-backend-list">
  <template>
  </template>

  <script>
    class BlBackendList extends BlAppComponentMixin(Polymer.Element) {
      
      static get is() { return 'bl-backend-list'; }

      static get properties() {
        return {
          
          /** 
           * Required. The list type determines the model and available actions.
           * Currently this only supports 'myGroups' and 'myBadges'.
           */
          type: String,
          
          /** 
           * Required. Bind this to the `status` property of the parent view.
           * Allows the list to load dynamically based on the view's status.
           */
          parentViewStatus: {
            type: String,
            observer: '_parentViewStatusChanged'
          },

          /** Used to initialize `_backendOperations` once `<bl-backend-client>` is initialized. */
          backendClientInitialized: {
            type: Boolean,
            readOnly: true,
            notify: true,
            observer: '_backendClientInitializedChanged'
          },

          /** 
           * If set to FALSE then the list 'auto loads', meaning that it gets the first page of results whenever the view goes to 
           * the 'active' state and reloads the results anytime the parameters change while the view is active.
           * Set to TRUE to disable the auto load. Then you must manually call the `listActions` methods to load results.
           */
          manualLoad: {
            type: Boolean,
            value: false
          },

          /** Optional. URL parameters to pass to the get operation. */
          parameters: {
            type: Object,
            notify: true,
            observer: '_parametersChanged',
            value: function() { return {} }
          },

          /**
           * Required. The target object receiving the binding. The following properties and methods are added on connection.
           * @property {object[]} items - The model items returned from the server. Getting more pages appends items to the end of the list.
           * @property {number} nextPage - The integer of the next page of results, equal to null if there are no more results.
           * @property {boolean} hasNextPage - True if nextPage is non-null.
           * @property {object} status - Stores the current state of the network connection.
           * @property {string} status.code - Equal to `uninitialized`, `loading`, `ready` or `error`.
           * @property {boolean} status.isInitialized - Always true once the inital loading is complete.
           * @property {boolean} status.isLoading - A network action is pending. True whenever the status is 'loading'.
           * @property {boolean} status.isReady - No network action is pending. True whenever the status is 'ready'.
           * @property {boolean} status.isError - True if the status is 'error'.
           * @property {string} status.errorMessage - Error message from backend. Null unless `isError` is `true`.
           * @property {object} listActions - Contains callbacks which apply list-level actions.
           * @property {function} listActions.getNextPage() - Adds next page of items to the items list, updates nextPage and hasNextPage.
           * @property {function} listActions.reload() - Resets the items list and gets the first page of results.
           * @property {object} selectionActions - NOT USED YET. Contains callbacks which apply actions to the currently selected items.
           */
          target: {
            type: Object,
            notify: true,
            value: function() { return {} }
          },

          /** 
           * Set using the `operationsByTag` method in `<bl-backend-client>`. Used to power public action methods.
           * Consuming components should not reference this object directly as it may change with future implementations.
           */
          _backendOperations: {
            type: Object,
            readOnly: true
          }

        }
      }

      // #=== PUBLIC ACTION METHODS ===#

      /** 
       * Clears current items and reloads first page.
       * Typically called via binding (`target.listActions.reload()`), but ok to call directly as well.
       */
      reload() {
        this.set('target.items', []);
        this.set('target.nextPage', 1);
        this.set('target.hasNextPage', undefined);
        this.getNextPage();
      }

      /** 
       * Loads next items and appends them to existing items. Then updates next page properties.
       * Typically called via binding (`target.listActions.getNextPage()`), but ok to call directly as well.
       */
      getNextPage() {
        var parametersWithPage;

        this._updateStatus('loading');

        // Clone the parameters so we can inject the page without messing up the bound parameters property
        parametersWithPage = {};
        Object.assign(parametersWithPage, this.parameters);
        parametersWithPage.page = (this.target.nextPage) ? this.target.nextPage : 1;

        this._backendOperations.paginatedList.get.do(parametersWithPage).then(function(response) {
          if (response.items && response.items.length)
            for (var i = 0; i < response.items.length; i++)
              this.push('target.items', response.items[i]);

          this.set('target.nextPage', response.next_page);
          this.set('target.hasNextPage', (response.next_page != null) && !isNaN(response.next_page));
          this._updateStatus('ready');
        }.bind(this)).catch(function(error) { 
          this._updateStatus('error', (error.errObj && error.errObj.message) ? error.errObj.message : error);
        }.bind(this));
      }
      
      // #=== PRIVATE ACTION METHODS ===#

      /** Sets and notifies all of the target properties related to status. Only include errorMessage if if statusCode is 'error'. */
      _updateStatus(statusCode, errorMessage) {
        var isInitialized = this.target.status.isInitialized || (statusCode == 'ready');
        var isLoading = (statusCode == 'loading');
        var isReady = (statusCode == 'ready');
        var isError = (statusCode == 'error');

        this.set('target.status.code', statusCode);

        // Only trigger a notification for the booleans if they are changing
        if (this.target.status.isInitialized != isInitialized) this.set('target.status.isInitialized', isInitialized);
        if (this.target.status.isLoading != isLoading) this.set('target.status.isLoading', isLoading);
        if (this.target.status.isReady != isReady) this.set('target.status.isReady', isReady);
        if (this.target.status.isError != isError) this.set('target.status.isError', isError);

        // Always trigger a notification for the error message, but ensure that it's always null if there's no error
        if (isError) this.set('target.status.errorMessage', errorMessage);
        else this.set('target.status.errorMessage', null);
      }

      /** Initializes the object bound to the target property. Adds callbacks and sets initial property values. */
      _setupTargetObject() {
        // Add to the existing target object instead of overwriting it, in case the parent element has given it extra properties
        this.set('target.items', []);
        this.set('target.nextPage', undefined);
        this.set('target.hasNextPage', undefined);
        this.set('target.status', {});
        this.set('target.status.code', 'uninitialized');
        this.set('target.status.isError', false);
        this.set('target.status.isInitialized', false);
        this.set('target.status.isLoading', false);
        this.set('target.status.isReady', false);
        this.set('target.status.errorMessage', null);

        // No need to notify for these ones
        this.target.listActions = {
          getNextPage: () => this.getNextPage(),
          reload: () => this.reload()
        }
        this.target.selectionActions = {}
      }

      // #=== LIFECYCLE EVENTS ===#

      connectedCallback() {
        if (super.connectedCallback) super.connectedCallback();

        // Add a listener for the backend client status
        this.app.$.backend.addEventListener('initialized-changed', e => this._appBackendInitializedChanged(e));
        
        // Setup the target object
        this._setupTargetObject();
      }

      // #=== LISTENER & OBSERVER METHODS ===#

      _parametersChanged(newValue, oldValue) {
        if (!this.manualLoad && this.backendClientInitialized && (this.parentViewStatus == 'active'))
          this.reload();
      }

      _parentViewStatusChanged(newValue, oldValue) {
        if (!this.manualLoad && (newValue == 'active') && (oldValue != 'active') && (this.backendClientInitialized))
          this.reload();
      }

      /** 
       * This method is fired via the listener setup in `connectedCallback()`. 
       * It copies the backend client initialization status to a local variable (so that it is available for other change observers).
       * It thus also triggers the local variable's change observer (`_backendClientInitializedChanged`) below.
       */
      _appBackendInitializedChanged(e) {
        this._setBackendClientInitialized(e.detail.value);
      }

      /** Initializes `_backendOperations` once the backend client is initialized. And potentially triggers a reload. */
      _backendClientInitializedChanged(newValue, oldValue) {
        if (newValue && !oldValue) {
          // First we need to create the action callbacks
          this._set_backendOperations(this.app.$.backend.operationsByTag(this.type));
          
          // Now trigger a reload if needed
          if (!this.manualLoad && (this.parentViewStatus == 'active'))
            this.reload();
        }
      }

    }

    window.customElements.define(BlBackendList.is, BlBackendList);
  </script>
</dom-module>
