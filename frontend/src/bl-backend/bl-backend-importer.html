<!-- #=== POLYMER & SHIMS ===# -->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- #=== BADGE LIST COMPONENTS ===# -->
<link rel="import" href="../bl-app/bl-app-component-mixin.html">

<!--
# Badge List Backend List Importer #

Use this component to bind a local component property with an import list endpoint in the Badge List backend.
The target object provides methods for building a list of items to import either manually or by importing from a local CSV file.
-->
<dom-module id="bl-backend-importer">
  <template>
  </template>

  <script>
    class BlBackendImporter extends BlAppComponentMixin(Polymer.Element) {
      
      static get is() { return 'bl-backend-importer'; }

      static get properties() {
        return {
          
          /** 
           * Required. The list type corresponds to a tag in swagger and determines the item properties.
           */
          type: String,

          /** 
           * This controls the number of items included in each import batch. It is set automatically to the `maxItems` value from the
           * swagger spec, but it can be specified manually instead. If the manually specified value is higher than the `maxItems` value
           * then it will be ignored.
           */
          importBatchSize: Number,

          /** Optional. Additional parameters to pass to the import action. */
          parameters: {
            type: Object,
            notify: true,
            value: function() { return {} }
          },

          /**
           * Required. The target object receiving the binding. The following properties and methods are added on connection.
           * @property {object[]} itemsToImport - The items passed in the body of the import action.
           *   You can add new items by using the `addItem` or `addItemsFromCSV` methods, but shouldn't modify the list directly.
           *   Each item has a `backend` object added to it which will contain: a `status` object with a `code`, 
           *   the `result` object returned from the server, a `remove()` function which will remove the specified item from the list.
           * @property {object[]} importedItems - After items are successfully imported they are removed from `itemsToImport` and added to
           *   this list. The items in this list have all of the same properties except there is no `remove()` method.
           * @property {object} status - Stores the current state of the import process.
           * @property {string} status.code - Equal to `uninitialized`, `ready`, `importing` or `error`.
           * @property {boolean} status.isReady - No network action is pending. True whenever the status is 'ready'.
           * @property {boolean} status.isImporting - An import is in progress. True whenever the status is 'importing'.
           * @property {boolean} status.isError - True if the status is 'error'.
           * @property {string} status.errorMessage - Error message from backend. Null unless `isError` is `true`.
           * @property {number} status.currentBatch - The number of the current import batch. From 1 to `batchCount`.
           * @property {number} status.batchCount - The total number of batches in the current import process.
           * @property {object} status.poller - Stores the poller object for the current import batch. Updated in real time.
           * @property {function} addItem() - Adds a new blank item to the end of the `itemsToImport` array.
           * @property {function} addItemsFromCSV(filePath) - Adds items from a local CSV file to the `itemsToImport` array.
           *   The CSV column headers are automatically matched with the itemProperties if possible. Return value is `true` if all of the
           *   CSV column headers are automatically matched or if all of the itemProperties are matched. Return value is `false` if the
           *   automatic column matching failed to match everything. If the return value is `false` then you will need to use the 
           *   `csvColumnMap` property to finish mapping the columns, then call `addItemsFromCSV` again.
           *   `addItemsFromCSV` will throw an error with a user-facing message if there are problems parsing or importing.
           * @property {function} clearItems() - Removes all items from `itemsToImport` array.
           * @property {object[]} itemProperties - Stores a copy of the properties object of the swagger schema used for the imported items 
           *   array. Object property names are the item keys, values are objects with properties for `type`, `description` 
           *   and potentially `format`.
           * @property {string[]} csvColumns - Ordered list of column headers from the CSV file. Set whenever `addItemsFromCSV` is called.
           * @property {object} csvColumnMap - Key-value store used to match CSV column headers with item property names. 
           *   `csvColumnMap` is automatically updated whenever `addItemsFromCSV` is called. Keys are the names of all the `itemProperties`,
           *    values are strings corresponding to values from `csvColumns`.
           * @property {function} import() - Initiates the import process. If `itemsToImport` has more than `importBatchSize` items then 
           *   the process will be broken up into multiple batches.
           */
          target: {
            type: Object,
            notify: true,
            value: function() { return {} }
          },

          /** 
           * Set using the `buildActionCallbacks` method in `<bl-backend-client>`. Used to power public action methods.
           * Consuming components should not reference this object directly as it may change with future implementations.
           */
          _clientActionCallbacks: {
            type: Object,
            readOnly: true
          }

        }
      }

      // #=== PUBLIC ACTION METHODS ===#

      /** xxxxxxx */
      addItem() {
        // ...
      }

      /** xxxxxxx */
      addItemsFromCSV(filePath) {
        // ...
      }

      /** xxxxxxx */
      clearItems() {
        // ...
      }

      /** xxxxxxx */
      import() {
        // ...
      }
      
      // #=== PRIVATE ACTION METHODS ===#

      /** Sets and notifies all of the target properties related to status. Only include errorMessage if if statusCode is 'error'. */
      _updateStatus(statusCode, errorMessage) {
        var isReady = (statusCode == 'ready');
        var isImporting = (statusCode == 'importing');
        var isError = (statusCode == 'error');

        this.set('target.status.code', statusCode);

        // Only trigger a notification for the booleans if they are changing
        if (this.target.status.isReady != isReady) this.set('target.status.isReady', isReady);
        if (this.target.status.isImporting != isImporting) this.set('target.status.isImporting', isImporting);
        if (this.target.status.isError != isError) this.set('target.status.isError', isError);

        // Always trigger a notification for the error message, but ensure that it's always null if there's no error
        if (isError) this.set('target.status.errorMessage', errorMessage);
        else this.set('target.status.errorMessage', null);
      }

      /** Initializes the object bound to the target property. Adds callbacks and sets initial property values. */
      _setupTargetObject() {
        // Add to the existing target object instead of overwriting it, in case the parent element has given it extra properties
        this.set('itemsToImport', []);
        this.set('importedItems', []);
        this.set('status', {});
        this.set('status.code', 'uninitialized');
        this.set('status.isReady', false);
        this.set('status.isImporting', false);
        this.set('status.isError', false);
        this.set('status.errorMessage', null);
        this.set('status.currentBatch', null);
        this.set('status.batchCount', null);
        this.set('status.poller', {});
        this.set('itemProperties', {});
        this.set('csvColumns', []);
        this.set('csvColumnMap', {});

        // No need to notify for these ones
        this.target.addItem = () => this.addItem();
        this.target.addItemsFromCSV = (filePath) => this.addItemsFromCSV(filePath);
        this.target.clearItems = () => this.clearItems();
        this.target.import = () => this.import();
      }

      // #=== LIFECYCLE EVENTS ===#

      connectedCallback() {
        if (super.connectedCallback) super.connectedCallback();

        // Add a listener for the backend client status
        this.app.$.backend.addEventListener('initialized-changed', e => this._appBackendInitializedChanged(e));
        
        // Setup the target object
        this._setupTargetObject();
      }

      // #=== LISTENER & OBSERVER METHODS ===#

      /** This method builds the `_clientActionCallbacks` when the backend client is initialized. */
      _appBackendInitializedChanged(e) {
        if (e.detail.value)
          this._set_clientActionCallbacks(this.app.$.backend.buildActionCallbacks(this.type));
      }

    }

    window.customElements.define(BlBackendImporter.is, BlBackendImporter);
  </script>
</dom-module>
