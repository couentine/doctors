<!-- #=== POLYMER & SHIMS ===# -->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- #=== STANDARD POLYMER COMPONENTS ===# -->
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">

<!-- #=== BADGE LIST COMPONENTS ===# -->
<link rel="import" href="bl-header-nav-left.html">
<link rel="import" href="bl-header-nav-right.html">
<link rel="import" href="bl-header-panel.html">
<link rel="import" href="bl-view-mixin.html">
<link rel="import" href="../bl-backend/bl-backend-importer.html">

<!--
# Badge List Bulk Add Badge Endorsements View #

Interface for bulk awarding badges. Only available to groups with the `bulk_tools` feature.
-->
<dom-module id="bl-view-badge-endorsements-add">
  <template>

    <style include="bl-style-classes">
      
      /* === LAYOUT & BASE STYLES === */
        
        :host {
          display: none;
        }
        :host([status=active]) {
          display: block;
        }

      /* === HEADER PANEL STYLES === */

        bl-header-panel {
          background: white;
        }
          #expandedBackground {
            border-bottom: 4px solid var(--bl-purple-400);
            background: linear-gradient(90deg, var(--bl-purple-500), var(--bl-purple-700));
          }
          #condensedBackground {
            border-bottom: 4px solid var(--bl-purple-400);
            background: linear-gradient(90deg, var(--bl-purple-500), var(--bl-purple-700));
          }
          #content {
            color: var(--bl-grey-800);
          }
          
          #leftNav {
            display: block;
            text-align: left;
            position: absolute;
            top: 0;
            right: 4em;
            bottom: 4px;
            left: 0;
            padding: 2em;
            
            font-size: 0.8rem;
            line-height: 1em;
          }
          @media (min-width: 480px) {
            #leftNav { font-size: 1rem; }
          }
            #headerImageWrapper {
              float: left;
              height: 100%;
              width: 5.7em;
              margin-right: 0.8em;
              display: flex;
              flex-direction: column;
              justify-content: center;
            }
              #headerImage { 
                width: 100%;
              }
            #headerText {
              display: flex;
              flex-direction: column;
              justify-content: center;
              height: 100%;
              color: white;
            }
              #subtitle {
                font-size: 1.5em;
                line-height: 1.6em;
                font-weight: 400;
              }
              #title {
                display: block;
                font-size: 3em;
                line-height: 1.1em;
                margin: 0;
                font-weight: 600;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                padding-bottom: 0.15em;
              }

          #rightNav {
            display: block;
            position: absolute;
            top: 0;
            right: 0;
            bottom: 4px;
            width: 4em;
            padding: 0;
            text-align: right;
          }
            #rightNav a, #rightNav a:visited {
              display: block;
              padding: 0.8rem;
              font-size: 2.3em;
              color: white;
              text-decoration: none;
            }

      /* === BETA CONTENT STYLES === */

        .contentBox {
          margin: 3em auto;
          max-width: 40em;
          padding: 0 2em;
          color: var(--bl-grey-700);
        }
          .contentBox a, .contentBox a:visited {
            color: var(--bl-grey-900);
          }

        #importerStatus {
          display: flex;
          align-items: center;
        }
          #importerStatus label {
            font-weight: bold;
            margin-right: 0.5em;
          }
          #importerStatus span {
            margin-right: 0.5em;
            text-transform: capitalize;
          }
          paper-spinner-lite { --paper-spinner-color: var(--bl-purple-500); }

        #importerActions paper-button {
          display: inline-block;
          margin: 0 1em 1em 0;
        }
        #importerActions paper-checkbox {
          display: inline-block;
          --primary-color: var(--bl-orange-600);
          --primary-text-color: var(--bl-grey-700);
        }
          #importerActions paper-checkbox .subtitle {
            display: block;
            font-size: 0.8em;
          }

        #importerCounts li label {
          font-weight: bold;
          margin-right: 0.5em;
        }

        #importerError {
          display: flex;
          align-items: center;
          margin-top: 0.5em;
          color: var(--bl-red-700);
        }
          #importerError label {
            margin-right: 0.5em;
          }
          #importerError span {
            margin-right: 0.5em;
            text-transform: capitalize;
          }
        
        #failedItems label {
          display: block;
          font-weight: bold;
          color: var(--bl-red-700);
          margin-bottom: 1em;
        }
        #failedItems table {
          width: 100%;
          border-collapse: collapse;
        }
          #failedItems table th {
            padding: 0.5em;
            background: var(--bl-red-300);
            color: white;
            border-bottom: 1px solid var(--bl-red-200);
          }
            #failedItems table th:first-child { border-top-left-radius: 3px; }
            #failedItems table th:last-child { border-top-right-radius: 3px; }
          #failedItems table td {
            padding: 0.5em;
            background: var(--bl-red-50);
            text-align: center;
          }
            #failedItems table td.errorMessage {
              color: var(--bl-red-300);
              font-weight: 500;
            }
            #failedItems table tbody tr:last-of-type td:first-child {
              border-bottom-left-radius: 3px;
            }
            #failedItems table tbody tr:last-of-type td:last-child {
              border-bottom-right-radius: 3px;
            }

    </style>

    <!-- #=== BACKEND LINKS ===# -->

    <bl-backend-importer id="importer" type="badgeEndorsements" record-id="[[badge.id]]" parameters="{{importerParameters}}"
      target="{{badgeEndorsements}}"></bl-backend-importer>

    <!-- #=== HEADER PANEL ===# -->

    <bl-header-panel id="headerPanel" expanded-height="10" condensed-height="3.5" expanded-percentage="{{expandedPercentage}}">
      <div id="expandedBackground" slot="expandedBackground">&nbsp;</div>
      <div id="condensedBackground" slot="condensedBackground">&nbsp;</div>

      <div id="leftNav" slot="leftNav" style$="padding: [[leftNavPaddingEm]]em;">
        <div id="headerImageWrapper" style$="width: [[headerImageSizeEm]]em;">
          <img id="headerImage" src$="[[badge.image_url]]">
        </div>
        <div id="headerText">
          <div id="subtitle" style$="font-size: [[subtitleFontSizeEm]]em;">Bulk Award</div>
          <h1 id="title" style$="font-size: [[titleFontSizeEm]]em;">[[badge.name]]</h1>
        </div>
      </div>
      <div id="rightNav" slot="rightNav">
        <a href$="[[badge.relative_url]]" style$="font-size: [[rightNavFontSizeEm]]em;">
          <i class="icon-cross"></i>
        </a>
      </div>

      <div id="footer" slot="footer">&nbsp;</div>

      <div id="content" slot="content">

        <!-- #=== BETA UI ===# -->
        
        <div id="explainerText" class="contentBox">
          This is a beta version of the bulk awarding tool. Please contact Badge List support if you have any questions.
          To use the tool you will need to build a CSV file with up to three columns: 
          Email, Summary and Body. Email and summary are required, body is optional. Body can contain HTML.
          <a href="https://s3.amazonaws.com/badgelist/templates/badge-endorsements.csv">A template file is available here</a>.
        </div>
        
        <div id="importerDetails" class="contentBox">
          <div id="importerStatus">
            <label>Importer Status</label>
            
            <span hidden="[[badgeEndorsements.status.isImporting]]">[[badgeEndorsements.status.code]]</span>
            <span hidden="[[!badgeEndorsements.status.isImporting]]">
              Importing Batch [[badgeEndorsements.status.currentBatch]] of [[badgeEndorsements.status.batchCount]]
              ([[badgeEndorsements.status.poller.progress]]%)
            </span>
            
            <paper-spinner-lite id="spinner" active="[[badgeEndorsements.status.isImporting]]"></paper-spinner-lite>
          </div>
          
          <div id="importerError" hidden="[[!badgeEndorsements.status.isError]]">
            <label><i class="icon-warning"></i></label>
            <span>[[badgeEndorsements.status.errorMessage]]</span>
          </div>
          
          <div id="importerCounts">
            <ul>
              <li>
                <label>Items Ready to Import:</label>
                <span>[[badgeEndorsements.status.readyItemCount]]</span>
              </li>
              <li>
                <label>Items Being Imported:</label>
                <span>[[badgeEndorsements.status.importingItemCount]]</span>
              </li>
              <li>
                <label>Failed Items:</label>
                <span>[[badgeEndorsements.status.failedItemCount]]</span>
              </li>
              <li>
                <label>Successfully Imported Items:</label>
                <span>[[badgeEndorsements.status.importedItemCount]]</span>
              </li>
            </ul>
          </div>
        </div>
        
        <div id="importerActions" class="contentBox" hidden="[[badgeEndorsements.status.isImporting]]">
          <paper-input id="csvFileInput" type="file" accept=".csv" on-change="_csvFileChanged" hidden></paper-input>
          
          <paper-button class="orange" on-tap="selectCSVFile">
            Import CSV File
          </paper-button>

          <paper-checkbox checked="{{importerParameters.send_emails_to_new_users}}">
            Send email notifications to new users
            <span class="subtitle">
              Existing users will always receive notifications according to their preferences.
            </span>
          </paper-checkbox>
        </div>

        <div id="failedItems" class="contentBox" hidden="[[!badgeEndorsements.status.failedItemCount]]">
          <label>Failed Items</label>
          <table>
            <thead>
              <tr>
                <th>Error</th>
                <th>Email</th>
                <th>Summary</th>
                <th>Body</th>
              </tr>
            </thead>
            <tbody>
              <template is="dom-repeat" items="[[badgeEndorsements.status.failedItems]]">
                <tr>
                  <td class="errorMessage">
                    <i class="icon-warning"></i>
                    [[item.backend.status.errorMessage]]
                  </td>
                  <td>[[item.email]]</td>
                  <td>[[item.summary]]</td>
                  <td>[[item.body]]</td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

      </div>
    </bl-header-panel>

  </template>

  <script>
    class BlViewBadgeEndorsementsAdd extends BlViewMixin(Polymer.Element) {

      static get is() { return 'bl-view-badge-endorsements-add'; }

      static get properties() {
        return {

          group: Object,

          badge: Object,
          
          badgeEndorsements: Object,

          expandedPercentage: Number,

          leftNavPaddingEm: {
            type: Number,
            computed: '_leftNavPaddingEm(expandedPercentage)'
          },

          headerImageSizeEm: {
            type: Number,
            computed: '_headerImageSizeEm(expandedPercentage)'
          },

          subtitleFontSizeEm: {
            type: Number,
            computed: '_subtitleFontSizeEm(expandedPercentage)'
          },

          titleFontSizeEm: {
            type: Number,
            computed: '_titleFontSizeEm(expandedPercentage)'
          },

          rightNavFontSizeEm: {
            type: Number,
            computed: '_rightNavFontSizeEm(expandedPercentage)'
          }

        }
      }

      // #=== PUBLIC ACTION METHODS ===#

      /** Triggers the hidden `csvFileInput` file input dialog. */
      selectCSVFile() {
        this.$.csvFileInput.inputElement.inputElement.click();
      }

      // #=== LIFECYCLE EVENTS ===#

      connectedCallback() {
        if (super.connectedCallback) super.connectedCallback();
        
        this.tryToHideIntercom();

        this.$.importer.addEventListener('csv-parsing-complete', e => this._startImportIfNeeded());
      }

      // #=== LISTENER & OBSERVER METHODS ===#

      _csvFileChanged() {
        if (this.$.csvFileInput.inputElement.inputElement.files.length)
          this.badgeEndorsements.addItemsFromCSV(this.$.csvFileInput.inputElement.inputElement.files[0]);
      }

      _startImportIfNeeded() {
        if (this.badgeEndorsements.status.readyItemCount)
          this.badgeEndorsements.import();
      }

      // #=== PROPERTY COMPUTER METHODS ===#

      _leftNavPaddingEm(expandedPercentage) {
        return this.linearExpansionValue(2.0, 0.8, expandedPercentage);
      }

      _headerImageSizeEm(expandedPercentage) {
        return this.linearExpansionValue(5.7, 2.0, expandedPercentage);
      }

      _subtitleFontSizeEm(expandedPercentage) {
        return this.linearExpansionValue(1.5, 0, expandedPercentage);
      }

      _titleFontSizeEm(expandedPercentage) {
        return this.linearExpansionValue(3.0, 1.5, expandedPercentage);
      }

      _rightNavFontSizeEm(expandedPercentage) {
        return this.linearExpansionValue(2.3, 1.5, expandedPercentage);
      }

    }

    window.customElements.define(BlViewBadgeEndorsementsAdd.is, BlViewBadgeEndorsementsAdd);
  </script>
</dom-module>