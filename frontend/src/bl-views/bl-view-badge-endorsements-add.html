<!-- #=== POLYMER & SHIMS ===# -->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<!-- #=== STANDARD POLYMER COMPONENTS ===# -->
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">

<!-- #=== BADGE LIST COMPONENTS ===# -->
<link rel="import" href="../bl-backend/bl-backend-importer.html">
<link rel="import" href="../bl-input/bl-input-rich-text.html">
<link rel="import" href="../bl-input/bl-input-text.html">
<link rel="import" href="bl-header-nav-left.html">
<link rel="import" href="bl-header-nav-right.html">
<link rel="import" href="bl-header-panel.html">
<link rel="import" href="bl-view-mixin.html">

<!--
# Badge List Bulk Add Badge Endorsements View #

Interface for bulk awarding badges. Only available to groups with the `bulk_tools` feature.
-->
<dom-module id="bl-view-badge-endorsements-add">
  <template>

    <style include="bl-style-classes">
      
      /* === LAYOUT & BASE STYLES === */
        
        :host {
          display: none;
        }
        :host([status=active]) {
          display: block;
        }

      /* === HEADER PANEL STYLES === */

        bl-header-panel {
          background: linear-gradient(205deg, var(--bl-orange-50), var(--bl-purple-50));
        }
          #expandedBackground {
            border-bottom: 4px solid var(--bl-purple-400);
            background: linear-gradient(90deg, var(--bl-purple-500), var(--bl-purple-700));
          }
          #condensedBackground {
            border-bottom: 4px solid var(--bl-purple-400);
            background: linear-gradient(90deg, var(--bl-purple-500), var(--bl-purple-700));
          }
          #content {
            color: var(--bl-grey-800);
          }
          
          #leftNav {
            display: block;
            text-align: left;
            position: absolute;
            top: 0;
            right: 4em;
            bottom: 4px;
            left: 0;
            padding: 2em;
            
            font-size: 0.8rem;
            line-height: 1em;
          }
          @media (min-width: 480px) {
            #leftNav { font-size: 1rem; }
          }
            #headerImageWrapper {
              float: left;
              height: 100%;
              width: 5.7em;
              margin-right: 0.8em;
              display: flex;
              flex-direction: column;
              justify-content: center;
            }
              #headerImage { 
                width: 100%;
              }
            #headerText {
              display: flex;
              flex-direction: column;
              justify-content: center;
              height: 100%;
              color: white;
            }
              #subtitle {
                font-size: 1.5em;
                line-height: 1.6em;
                font-weight: 400;
              }
              #title {
                display: block;
                font-size: 3em;
                line-height: 1.1em;
                margin: 0;
                font-weight: 600;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                padding-bottom: 0.15em;
              }

          #rightNav {
            display: block;
            position: absolute;
            top: 0;
            right: 0;
            bottom: 4px;
            width: 4em;
            padding: 0;
            text-align: right;
          }
            #rightNav a, #rightNav a:visited {
              display: block;
              padding: 0.8rem;
              font-size: 2.3em;
              color: white;
              text-decoration: none;
            }

      /* === SHARED CONTENT STYLES === */

        .contentBlock {
          margin: 3em auto;
          max-width: 40rem;
          padding: 0 2em;
          color: var(--bl-grey-700);
        }
        
          .sectionHeader {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 1.5rem;
          }

          .optionButtons {
            display: block;
            margin: 0;
            padding: 0 1px;
            list-style: none;
            border-radius: 9px;
            background: var(--bl-orange-500);

            @apply --bl-shadow-3;
          }
            .optionButtons>li {
              display: block;
              border-bottom: 1px solid var(--bl-orange-400);
            }
            .optionButtons>li:last-child {
              border-bottom: none;
            }
              .optionButtons>li>a {
                display: flex;
                align-items: center;
                color: var(--bl-orange-50);
                text-decoration: none;
                padding: 1em;
              }
                .optionButtons>li>a>i {
                  font-size: 1.5em;
                  margin-right: 0.5rem;
                }
                .optionButtons>li>a>span {
                  font-size: 1.1em;
                }

      /* === DIALOGS === */

        paper-dialog {
          --bl-dialog-gradient-color1: var(--bl-purple-500);
          --bl-dialog-gradient-color2: var(--bl-orange-500);
        }
      
      /* === TABLE PANEL === */

        #tablePanel {
          position: absolute;
          top: 11em;
          right: 1em;
          bottom: 1em;
          left: 1em;
        }
          #tableMenu {
            list-style: none;
            margin: 0;
            padding: 0 0 0.9em 0;
            display: flex;
          }
            #tableMenu>li {
              display: block;
            }
              #tableMenu>li>paper-button {
                color: var(--bl-orange-700);
                font-weight: 600;
              }
          #tableContent {
            background: white;
            border-radius: 9px;

            @apply --bl-shadow-5;
          }
            #tableContent table {
              width: 100%;
              border-collapse: collapse;
            }
              #tableContent table tr th {
                font-size: 0.8em;
                padding: 1em 0.7em;
                border-bottom: 1.5px solid var(--bl-orange-100);
                color: var(--bl-orange-300);
                text-transform: uppercase;
              }
              #tableContent table tr td {
                padding: 0.3em 0.7em;
                border-bottom: 1px solid var(--bl-grey-100);
                text-align: center;
              }
                #tableContent table tr td pre {
                  font-family: 'Roboto Mono';
                  font-size: 0.6em;
                  max-width: 30em;
                  white-space: pre-wrap;
                  padding: 0.2em;
                  margin: auto;
                 
                  border-radius: 3px;
                  border: 1px solid var(--bl-grey-300);
                  background: var(--bl-grey-200);
                }
              #tableContent table tr.actionRow td {
                padding: 0.5em;
                color: var(--bl-grey-500);
                background: var(--bl-grey-50);
                border-radius: 0 0 9px 9px;
                border: none;
              }
                #tableContent table tr.actionRow td paper-button {
                  color: var(--bl-orange-300);
                  padding: 0.5em
                }

    </style>

    <!-- #=== BACKEND LINKS ===# -->

    <bl-backend-importer id="importer" type="badgeEndorsements" record-id="[[badge.id]]" parameters="{{importerParameters}}"
      target="{{badgeEndorsements}}"></bl-backend-importer>

    <!-- #=== HEADER PANEL ===# -->

    <bl-header-panel id="headerPanel" expanded-height="10" condensed-height="3.5" expanded-percentage="{{expandedPercentage}}">
      <div id="expandedBackground" slot="expandedBackground">&nbsp;</div>
      <div id="condensedBackground" slot="condensedBackground">&nbsp;</div>

      <div id="leftNav" slot="leftNav" style$="padding: [[leftNavPaddingEm]]em;">
        <div id="headerImageWrapper" style$="width: [[headerImageSizeEm]]em;">
          <img id="headerImage" src$="[[badge.image_url]]">
        </div>
        <div id="headerText">
          <div id="subtitle" style$="font-size: [[subtitleFontSizeEm]]em;">Bulk Award</div>
          <h1 id="title" style$="font-size: [[titleFontSizeEm]]em;">[[badge.name]]</h1>
        </div>
      </div>
      <div id="rightNav" slot="rightNav">
        <a href$="[[badge.relative_url]]" style$="font-size: [[rightNavFontSizeEm]]em;">
          <i class="icon-cross"></i>
        </a>
      </div>

      <div id="footer" slot="footer">&nbsp;</div>

      <div id="content" slot="content">

        <!-- #=== BLANK PANEL ===# -->

        <div id="blankPanel" hidden="[[hasItems]]">
          <div class="contentBlock">
            The bulk award tool allows you to create badge endorsements for many people at a time, even if they are not yet a member of your 
            Badge List group. You will need to build a list of endorsement items. Each item must have an email address and a 
            &ldquo;summary&rdquo;, which is the text that is displayed on the badge recipient's portfolio.
            You can optionally include an endorsement body as well.
          </div>

          <div class="contentBlock">
            <div class="sectionHeader">
              To add new endorsement items you have three options:
            </div>

            <ul class="optionButtons">
              <li>
                <a href="#" on-tap="importCSV">
                  <i class="icon-file-spreadsheet"></i>
                  <span>Add items from a CSV file</span>
                </a>
              </li>
              <li>
                <a href="#" on-tap="pasteEmails">
                  <i class="icon-paste"></i>
                  <span>Copy &amp; paste a list of email addresses</span>
                </a>
              </li>
              <li>
                <a href="#" on-tap="newItem">
                  <i class="icon-edit"></i>
                  <span>Type in items one at a time</span>
                </a>
              </li>
            </ul>
          </div>
        </div>

        <!-- <div id="editItemPanel">
          <div class="contentBlock">
            <div class="formDialog">
              <div class="formTitle">
                <h3 hidden="[[!activePanelIsNewItem]]">Add Item</h3>
                <h3 hidden="[[!activePanelIsEditItem]]">Edit Item</h3>
              </div>
              <div class="formIcon">
                <i class="icon-certificate"></i>
              </div>
              
              <div class="formBody">
                <iron-form id="editItemForm">
                  <form>
                    <bl-input-text id="selectedItemEmail" label="Email" format="email" value="{{badgeEndorsements.selectedItem.email}}"
                      class="orange">
                    </bl-input-text>
                    <bl-input-text id="selectedItemSummary" label="Feedback Summary" value="{{badgeEndorsements.selectedItem.summary}}"
                      class="orange">
                    </bl-input-text>
                    <bl-input-rich-text id="selectedItemBody" label="Feedback Body" value="{{badgeEndorsements.selectedItem.body}}"
                      class="orange">
                    </bl-input-rich-text>
                  </form>
                </iron-form>
              </div>
              
              <div class="formFooter">
                <paper-button class="orange transparent borderless" on-tap="removeItem">
                  <i class="icon-trash"></i>
                  <span hidden="[[!activePanelIsNewItem]]">Discard</span>
                  <span hidden="[[!activePanelIsEditItem]]">Delete</span>
                </paper-button>
                <paper-button class="orange primary" on-tap="saveItem">Save</paper-button>
              </div>
            </div>
          </div>
        </div> -->

        <!-- #=== TABLE PANEL ===# -->

        <div id="tablePanel" hidden="[[!hasItems]]">
          <ul id="tableMenu">
            <li>
              <paper-button on-tap="importCSV" class="transparent borderless icon">
                <i class="icon-file-spreadsheet"></i>
                <span>Import CSV</span>
              </paper-button>
            </li>
            <li>
              <paper-button on-tap="pasteEmails" class="transparent borderless icon">
                <i class="icon-paste"></i>
                <span>Paste emails</span>
              </paper-button>
            </li>
          </ul>
          <div id="tableContent">
            <table>
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Summary</th>
                  <th>Body</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <template is="dom-repeat" items="[[badgeEndorsements.itemsToImport]]">
                  <tr>
                    <td>[[item.email]]</td>
                    <td>[[item.summary]]</td>
                    <td>
                      <pre hidden="[[!item.body]]">[[item.body]]</pre>
                    </td>
                    <td>
                      <paper-button class="transparent borderless icon" on-tap="selectItem">
                        <i class="icon-pencil"></i>
                      </paper-button>
                    </td>
                  </tr>
                </template>
                <tr class="actionRow">
                  <td colspan="4">
                    <paper-button class="transparent borderless icon" on-tap="newItem">
                      <i class="icon-plus"></i>
                      Add new item
                    </paper-button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </bl-header-panel>

    <!-- #=== EDIT ITEM DIALOG ===# -->

    <paper-dialog id="editItemDialog" class="orange dialog-gradients" modal dynamic-align>
      <h2 hidden="[[!selectedItemIsNew]]">Add Item</h2>
      <h2 hidden="[[selectedItemIsNew]]">Edit Item</h2>
            
      <paper-dialog-scrollable>
        <div class="formIcon">
          <i class="icon-certificate"></i>
        </div>
        
        <iron-form id="editItemForm">
          <form>
            <bl-input-text id="selectedItemEmail" label="Email" format="email" value="{{badgeEndorsements.selectedItem.email}}"
              class="orange" autofocus>
            </bl-input-text>
            <bl-input-text id="selectedItemSummary" label="Feedback Summary" value="{{badgeEndorsements.selectedItem.summary}}"
              class="orange">
            </bl-input-text>
            <bl-input-rich-text id="selectedItemBody" label="Feedback Body" value="{{badgeEndorsements.selectedItem.body}}"
              class="orange">
            </bl-input-rich-text>
          </form>
        </iron-form>
      </paper-dialog-scrollable>

      <div class="buttons">
        <paper-button class="orange transparent borderless" on-tap="removeItem" dialog-dismiss>
          <i class="icon-trash"></i>
          <span hidden="[[!selectedItemIsNew]]">Discard</span>
          <span hidden="[[selectedItemIsNew]]">Delete</span>
        </paper-button>
        <paper-button class="orange primary" on-tap="saveItem" dialog-confirm>
          Save
        </paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    class BlViewBadgeEndorsementsAdd extends BlViewMixin(Polymer.Element) {

      static get is() { return 'bl-view-badge-endorsements-add'; }

      static get properties() {
        return {

          group: Object,

          badge: Object,
          
          badgeEndorsements: Object,

          /** Used internally to control the current display mode. */
          hasItems: {
            type: Boolean,
            value: false,
            readOnly: true
          },
          
          /** Used internally to control the display of the edit item dialog. */
          selectedItemIsNew: {
            type: Boolean,
            readOnly: true
          },

          expandedPercentage: Number,

          leftNavPaddingEm: {
            type: Number,
            computed: '_leftNavPaddingEm(expandedPercentage)'
          },

          headerImageSizeEm: {
            type: Number,
            computed: '_headerImageSizeEm(expandedPercentage)'
          },

          subtitleFontSizeEm: {
            type: Number,
            computed: '_subtitleFontSizeEm(expandedPercentage)'
          },

          titleFontSizeEm: {
            type: Number,
            computed: '_titleFontSizeEm(expandedPercentage)'
          },

          rightNavFontSizeEm: {
            type: Number,
            computed: '_rightNavFontSizeEm(expandedPercentage)'
          }

        }
      }

      // #=== PUBLIC ACTION METHODS ===#

      /** Updates the display mode. Shows the add item panel. */
      newItem() {
        this.badgeEndorsements.addItem();
        this._setSelectedItemIsNew(true);
        this.$.editItemDialog.open();
      }

      /** Selects the current item. Expects `e.detail.model.item` to point to the item. */
      selectItem(e) {
        if (e && e.model && e.model.item && e.model.item.backend && e.model.item.backend.select) {
          e.model.item.backend.select();
          this._setSelectedItemIsNew(false);
          this.$.editItemDialog.open();
        }
      }

      saveItem() {
        if (this.badgeEndorsements.itemsToImport.length)
          this._setHasItems(true);
        else
          this._setHasItems(false);
        
        this.$.editItemDialog.close();
      }

      removeItem() {
        this.badgeEndorsements.selectedItem.backend.remove();

        if (this.badgeEndorsements.itemsToImport.length)
          this._setHasItems(true);
        else
          this._setHasItems(false);
        
        this.$.editItemDialog.close();
      }

      /** Triggers the hidden `csvFileInput` file input dialog. */
      selectCSVFile() {
        this.$.csvFileInput.inputElement.inputElement.click();
      }

      // #=== LIFECYCLE EVENTS ===#

      connectedCallback() {
        if (super.connectedCallback) super.connectedCallback();
        
        this.tryToHideIntercom();

        this.$.importer.addEventListener('csv-parsing-complete', e => this._startImportIfNeeded());
      }

      // #=== LISTENER & OBSERVER METHODS ===#

      _csvFileChanged() {
        if (this.$.csvFileInput.inputElement.inputElement.files.length)
          this.badgeEndorsements.addItemsFromCSV(this.$.csvFileInput.inputElement.inputElement.files[0]);
      }

      _startImportIfNeeded() {
        if (this.badgeEndorsements.status.readyItemCount)
          this.badgeEndorsements.import();
      }

      // #=== PROPERTY COMPUTER METHODS ===#

      _leftNavPaddingEm(expandedPercentage) {
        return this.linearExpansionValue(2.0, 0.8, expandedPercentage);
      }

      _headerImageSizeEm(expandedPercentage) {
        return this.linearExpansionValue(5.7, 2.0, expandedPercentage);
      }

      _subtitleFontSizeEm(expandedPercentage) {
        return this.linearExpansionValue(1.5, 0, expandedPercentage);
      }

      _titleFontSizeEm(expandedPercentage) {
        return this.linearExpansionValue(3.0, 1.5, expandedPercentage);
      }

      _rightNavFontSizeEm(expandedPercentage) {
        return this.linearExpansionValue(2.3, 1.5, expandedPercentage);
      }

    }

    window.customElements.define(BlViewBadgeEndorsementsAdd.is, BlViewBadgeEndorsementsAdd);
  </script>
</dom-module>