<% 
  provide(:title, "\##{@group_tag.name_with_caps} - #{@group.name}")  
  provide(:page_background, '#EEEEEE')
  provide(:white_header_text, 'true')
  provide(:hide_left_nav, 'true')
%>

<% #=== APP HEADER CONTENT ===# %>

  <% content_for :app_header_content do %>
    <bl-app-header-tag name="<%= @group_tag.name_with_caps %>" 
      back-url="<%= group_tags_url(@group) %>"></bl-app-header-tag>
  <% end %>

<% #=== PAGE BODY CONTENT ===# %>
  
  <style type="text/css">
    
    #page-header {
      padding: 3.75em 2em 2.5em 2em;
      position: relative;
    }
      #summary {
        text-align: center;
        max-width: 30em;
        margin: 0 auto;
      }
      #editButtons {
        position: absolute;
        left: 0;
        right: 0;
        top: 1.5em;
        text-align: center;
      }
        #editButtons a, #editButtons a:visited {
          color: #9E9E9E;
          text-decoration: none;
          font-style: italic;
          font-size: 0.8em;
        }
        #editButtons a:focus, #editButtons a:hover { color: #212121; }

    #group-tags-panel {
      margin: 0 1em;
      padding-bottom: 0.5em;
      background: white;
      border: 1px solid #E0E0E0;
      border-radius: 1.25rem;
    }
    @media (min-width: 840px) { #group-tags-panel { margin: 0 2em; padding-bottom: 2em; } }
    @media (min-width: 1200px) { #group-tags-panel { margin: 0 4em; padding-bottom: 4em; } }
      #userList {
        min-height: 22em;
      }
        #add-users {
          background: #03A9F4;
        }

  </style>

  <!-- #=== AJAX CALL TO REMOVE A USER ===# -->
  <iron-ajax id="removeUserAjax" bubbles method="DELETE" content-type="application/json"
    headers='{"X-CSRF-Token": "<%= form_authenticity_token.to_s %>"}'></iron-ajax>
  <bl-ajax-status for="removeUserAjax">Removing user...</bl-ajax-status>
  
  <!-- #=== AJAX CALL TO DELETE TAG ===# -->
  <iron-ajax id="deleteGroupTagAjax" bubbles method="DELETE" content-type="application/json"
    headers='{"X-CSRF-Token": "<%= form_authenticity_token.to_s %>"}'
    url="<%= group_tag_url(@group, @group_tag) %>"></iron-ajax>

  <!-- #=== PAGE HEADER ===# -->

  <div id="page-header">
    <% if @can_edit_group_tags %>
      <div id="editButtons">
        <a href="#" onClick="deleteGroupTag(); return false;">
          <i class="fa fa-trash"></i> Delete Group Tag
        </a>
      </div>
    <% end %>
    <div id="summary">
      <%= @group_tag.summary %>
    </div>
  </div>

  <!-- #=== GROUP TAG USERS ===# -->

  <div id="group-tags-panel">
  
    <bl-list id="userList" object-mode="users" refresh-query-on-load
        query-options="<%= @query_options %>" item-display-mode="<%= @item_display_mode %>"
        next-page-url="<%= group_tag_users_url(@group, @group_tag, format: :json) %>">

      <!-- #=== LIST CONTROLS ===# -->
      <div class="list-controls">
        <ul class="left">
          <bl-query-options for="userList" selected-options="<%= @sort_options %>" 
              class="query-filter-option">
            <paper-dropdown-menu label="Sort order" class="query-options-dropdown" 
                horizontal-align="left" veritcal-align="bottom">
              <paper-listbox class="dropdown-content">
                <paper-item data-options='{"sort_by":"name","sort_order":"asc"}'>
                  By name
                </paper-item>
                <paper-item data-options='{"sort_by":"name","sort_order":"desc"}'>
                  Reverse name
                </paper-item>
                <paper-item data-options='{"sort_by":"username","sort_order":"asc"}'>
                  By username
                </paper-item>
                <paper-item data-options='{"sort_by":"username","sort_order":"desc"}'>
                  Reverse username
                </paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
          </bl-query-options>
        </ul>
        <% if @can_assign_group_tags %>
          <ul class="right">
            <li>
              <bl-button id="add-users" type="flat"
                  link="<%= add_group_tag_users_path(@group, @group_tag) %>">
                <i class="fa fa-plus"></i> &nbsp; Add Users
              </bl-button>
            </li>
          </ul>
        <% end %>
      </div>


      <!-- #=== PLACEHOLDER ===# -->
      <div class="placeholder transparent">
        <i class="fa fa-user"></i>
        <div class="message">
          <p><b>No users have been added to this tag yet.</b></p> 
          <% if @can_assign_group_tags %>
            <p>Click the 'Add Users' button above to add some.</p>
          <% end %>
        </div>
      </div>

    </bl-list>


    <!-- #=== PAGE-SPECIFIC JAVASCRIPT ===# -->

    <script type="text/javascript">

      // #=== EVENT LISTENER SETUP ===# 
      appLayout.addEventListener('dom-change', function() {
        document.addEventListener('bl-user-remove', handleBLUserRemove);
        
        document.getElementById('removeUserAjax')
          .addEventListener('iron-ajax-response', handleRemoveUserResponse);
        document.getElementById('removeUserAjax')
          .addEventListener('iron-ajax-error', handleRemoveuserError);
        
        document.getElementById('deleteGroupTagAjax')
          .addEventListener('iron-ajax-response', handleDeleteGroupTagResponse);
        document.getElementById('deleteGroupTagAjax')
          .addEventListener('iron-ajax-error', handleDeleteGroupTagError);
      });

      // #=== USER REMOVE HANDLING ===# 
      
      var removeUserBaseUrl = '<%= "#{group_tag_users_url(@group, @group_tag)}/" %>';

      function handleBLUserRemove(e) {
        var user = e.detail.user;

        appContainer.openAlertDialog({
          color: 'green',
          title: 'Remove ' + user.name + ' from tag?',
          body: 'The user will only be removed from the tag, not from the group itself. '
            + 'They can be added back to the tag at any time.',
          confirm: {
            text: 'Remove them',
            action: function() {
              var removeUserAjax = document.getElementById('removeUserAjax');
              removeUserAjax.url = removeUserBaseUrl + user.id + '.json'
              removeUserAjax.generateRequest();
              
              // Hide the bl-list-item for this user
              document.querySelector('[item-id="' + user.id + '"]').hidden = true;
            }
          },
          dismiss: { text: 'Nevermind' }
        });
      }

      function handleRemoveUserResponse(e) {
        var response = e.detail.response;
        var user = response.user;

        if (response.success) {
          appContainer.addToast(user.name + ' was removed from the tag', 'success');
        } else {
          appContainer.addToast('There was a problem removing ' + user.name + ' from the tag '
            + '(Error Message: ' + response.error_message + ')', 'error', 30000);

          // Unhide the bl-list-item for this user
          document.querySelector('[item-id="' + user.id + '"]').hidden = false;
        }
      }

      function handleRemoveuserError(e) {
        appContainer.addToast('There was a problem removing the user from the tag, '
          + 'please refresh the page and try again', 'error', 30000);
      }

      // #=== TAG DELETE HANDLING ===# 

      function deleteGroupTag() {
        appContainer.openAlertDialog({
          color: 'red',
          title: 'Delete the #<%= @group_tag.name_with_caps %> tag?',
          body: 'Are you sure you want to remove all users from this tag and then delete the tag '
            + 'itself? This cannot be undone.',
          confirm: {
            text: 'Delete this tag',
            action: function() {
              document.getElementById('deleteGroupTagAjax').generateRequest();
              appContainer.openWaitingDialog({ color: 'red', title: 'Deleting group tag...' });
            }
          },
          dismiss: { text: 'Nevermind' }
        });
      }

      function handleDeleteGroupTagResponse(e) {
        var response = e.detail.response;
        var user = response.user;

        if (response.success) {
          document.location.href = '<%= group_tags_url(@group) %>';
        } else {
          appContainer.closeWaitingDialog();
          appContainer.addToast('There was a problem deleting this tag. '
            + '(Error Message: ' + response.error_message + ')', 'error', 30000);
        }
      }

      function handleDeleteGroupTagError(e) {
        appContainer.closeWaitingDialog();
        appContainer.addToast('There was a problem deleting this tag. Please try again.', 
          'error', 30000);
      }

    </script>

  </div>