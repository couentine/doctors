<% 
  provide(:title, "All Groups")

  owner_index = {}
%>

<style type="text/css">
  
  a.label {
    color: white !important;
  }
  a.label:hover, a.label:focus {
    background-color: #333;
  }

</style>

<!-- === PAGE HEADER === -->

<div class="row add-top-margin">
  <div class="span12">
    <div class="header-card admin-header-card">
      <div class="white-background no-tabs">&nbsp;</div>

      <div class="primary-header span6">
        <span class="header-image" >
          <i class="fa fa-user"></i>
        </span>
        <span class="header-text">
          <h1>Badge List Groups</h1>
          <h2>Admin Tools</h2>
        </span>
      </div>

      <div class="secondary-header span6">
        <span class="header-text">
          <h2>
            Showing <%= ((@page.to_i - 1) * @page_size.to_i) + 1 %>
            - <%= [(@page.to_i * @page_size.to_i), @groups.count].min %>
            of <%= @groups.count %>
          </h2>
          <h2>
            <% if params[:type] || params[:plan] || params[:status] %>
              Filters:
              <%= link_to 'Clear search', group_index_path, class: 'btn btn-small' %>
            <% else %>
              Default Filters:
            <% end %>
          </h2>
          <h3>
            <ul>
              <li>
                <strong>Type =</strong> 
                <%= (params[:type]) ? "#{@types.first}" : "Any" %>
              </li>
              <li>
                <strong>Plan = </strong> 
                <%= (params[:plan]) ? "#{@plans.first}" : "Any" %>
              </li>
              <li>
                <strong>Status = </strong> 
                <%= (params[:status]) ? "#{@stati.first}" : "Any" %>
              </li>
            </ul>
          </h3>
        </span>            
      </div>
    </div>
  </div>
</div>

<!-- === ENTRIES LIST === -->

<% if !@groups.blank? %>
  
  <div class="row">
    <div class="span12">
      <div class="pagination-header">
        <div class="pagination"><%= paginate @groups %></div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="span12">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Group</th>
              <th>Type, Plan, Status</th>
              <th>Owner</th>
              <th>Created</th>
              <th>Admins, Members</th>
              <th>Active Users / Limit</th>
              <th>User Activity History</th>
              <th>Badges</th>
            </tr>
          </thead>
          <tbody>
            <% @groups.each do |group| %>
              <tr>
                <td>
                  <a href="<%= group_path(group) %>">
                    <%= group.name %>
                  </a>
                </td>
                <td>
                  <%= link_to group.type.capitalize, group_index_path(page_size: @page_size, 
                    type: group.type, plan: params[:plan], status: params[:status]) %>
                  <% if group.private? %>
                    - 
                    <%= link_to group.subscription_plan, group_index_path(page_size: @page_size, 
                      type: params[:type], plan: group.subscription_plan, status: params[:status]), 
                      class: 'label' %>
                    
                    <% subscription_status = group.status_details_for_admins %>
                    <%= link_to group.subscription_status_string, group_index_path(page_size: @page_size,
                      type: params[:type], plan: params[:plan], 
                      status: group.stripe_subscription_status), 
                      class: "label #{subscription_status[:color]}" %>
                  <% end %>
                </td>
                <td>
                  <% 
                    owner = owner_index[group.owner_id] \
                      || (User.find(group.owner_id) rescue nil)

                    if owner && !owner_index.has_key?(owner.id)
                      owner_index[owner.id] = owner
                    end
                  %>

                  <% if owner %>
                    <%= link_to owner.name, user_path(owner), target: '_blank' %>
                    (<%= owner.email %>)
                  <% else %>
                    [ Deleted User ]
                  <% end %>
                </td>
                <td>
                  <%= group.created_at.to_s :short_date %>
                </td>
                <td>
                  <%= group.admin_ids.count %>, <%= group.member_ids.count %>
                </td>
                <td>
                  <%= group.active_user_count || 0 %> / 
                  <%= (group.public? || (group.user_limit < 0)) ? '&infin;'.html_safe \
                    : group.user_limit %>
                </td>
                <td>
                  <% unless group.monthly_active_users.nil? %>
                    <%
                      flattened_map = []
                      group.monthly_active_users.each_pair do |key, value|
                        flattened_map << key + " = " + value.count.to_s
                      end
                    %>
                    <%= flattened_map.join(', ') %>
                  <% end %>
                </td>
                <td><%= (group.badge_ids || []).count %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
    </div>
  </div>

  <div class="row">
    <div class="span12">
      <div class="pagination-footer">
        <div class="pagination"><%= paginate @groups %></div>
      </div>
    </div>
  </div>

<% end %>