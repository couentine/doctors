<div class="spinner-wrapper" id="image-upload-spinner" style="display: none;">
  <div class="spinner-text large">
    <i class="fa fa-refresh fa-spin"></i> Uploading...
  </div>
</div>

<%= simple_form_for [@group, @badge, @log, @entry], html: {class: 'form-horizontal'} do |f| %>

  <div class="form-body">
    <% if @entry.type == 'validation' %>
      <%= f.input :log_validated, as: :radio_buttons, 
        label: "Do you endorse #{@user.name}'s achievement of this badge?",
        collection: [
          ['<b>Yes</b>, issue the badge'.html_safe, true],
          ['<b>Not yet</b>, greater mastery is needed'.html_safe, false]
        ] %>
    <% end %>

    <% if @entry.format == 'link' %>

      <!-- === WEB LINK === -->

      <%= f.input :link_url, label: 'Link URL', auto_focus: true, 
        input_html: { title: 'Paste a web URL', 
        placeholder: 'http://example.org/web-link.html', class: 'input-xlarge', 
        data: { toggle: 'tooltip' } } %>

      <%= f.input :summary, as: :text, label: 'Description', input_html: { data: {
        :'character-count' => true, :'max-length' => Entry::MAX_SUMMARY_LENGTH },
        cols: '200', rows: '5' } %>

      <script type="text/javascript">
        $(document).ready(function() { $("#entry_link_url").focus() });
      </script>

    
    <% elsif @entry.format == 'tweet' %>

      <!-- === TWITTER LINK === -->

      <%
        show_existing = !@entry.errors[:link_url].blank? || !@entry.new_record?
      %>

      <ul id="tweet-input-selection" style="<%= (show_existing) ? 'display: none;' : '' %>">
        <li>
          <a href="#" class="btn btn-success btn-large" id="show-tweet-input-existing">
            <i class="fa fa-link"></i>
            Post an existing tweet
          </a>
        </li>
        <li>
          <a href="#" class="btn btn-primary btn-large" id="show-tweet-input-new">
            <i class="fa fa-twitter"></i>
            Post a new tweet right now
          </a>
        </li>
      </ul>

      <div id="tweet-input-existing" style="<%= (show_existing) ? '': 'display: none;' %>">
        <%= f.input :link_url, label: 'Tweet URL', auto_focus: true,
          input_html: { class: 'input-xxlarge',
          placeholder: 'https://twitter.com/example/status/9876543210',
          title: 'Copy and paste the tweet URL here.', 
          data: { toggle: 'tooltip' } } %>

        <div class="control-group">
          <div class="controls help-info">
            To get the url of an existing tweet, click on the tweet and then click the "Details"
            link in the footer if it appears. Then just copy and paste the url from your browser's
            location  bar.
          </div>
        </div>
      </div>

      <div id="tweet-input-new" style="display: none;">

        <div class="control-group">
          <label class="optional control-label">Instructions</label>
          <div class="controls help-info">
            Clicking the button below will open a new Twitter window.
            After you tweet, click "View it on Twitter" and then copy the url from your browser's
            location bar and return to this window.
          </div>
        </div>
        <div class="control-group">
          <div class="controls">
            <% twitter_url = \
              "http://twitter.com/intent/tweet?original_referer=http://badgelist.com" \
              + "&related=BadgeList&tw_p=tweetbutton"; %>

            <a href="<%= twitter_url %>" class="btn btn-primary btn-large" id="go-to-twitter"
                target="_blank">
              <i class="fa fa-twitter"></i>
              Go to Twitter <i class="fa fa-angle-double-right"></i>
            </a>
          </div>
        </div>
      </div>

      <script type="text/javascript">
        var twitterWindow;

        $(document).ready(function() { 
          
          $("#show-tweet-input-existing").click(function(e) {
            $("#tweet-input-selection").slideUp();
            $("#tweet-input-existing").slideDown();
            e.preventDefault();
          });
          
          $("#show-tweet-input-new").click(function(e) {
            $("#tweet-input-selection").slideUp();
            $("#tweet-input-new").slideDown();
            e.preventDefault();
          });

          $("#go-to-twitter").click(function() {
            $("#tweet-input-new").slideUp();
            $("#tweet-input-existing").slideDown();
          });

        });
      </script>
    
    <% elsif @entry.format == 'code' %>

      <!-- === CODE SNIPPET RESPONSE === -->

      <%= f.input :body, as: :text, label: 'Code', 
        input_html: { class: "huge-text-area code-text-area" } %>  
      
      <%= render 'shared/ace', element_id: 'entry_body', ace_theme: 'idle_fingers',
        code_format: (@entry.code_format || 'javascript'), use_worker: false, read_only: false  %>

      <script>
          $(document).ready(function() {
            // Update the code format when the select list changes
            $("#entry_code_format").change(function() { 
              aceEditor.getSession().setMode("ace/mode/" + $(this).val()) 
              aceEditor.getSession().setUseWorker(true);
            });

            // Update the input element body each time the code changes
            aceEditor.getSession().on('change', function() {
              $("#entry_body").val(aceEditor.getValue());
            });
            
            // Focus and scroll to the editor
            $(aceEditor).focus();
          });
      </script>
      
      <%= f.input :body, as: :hidden %>

      <%= f.input :code_format, as: :select, label: 'Code Language', 
        collection: @code_language_options %>

      <%= f.input :summary, as: :text, label: 'Description', input_html: { data: {
        :'character-count' => true, :'max-length' => Entry::MAX_SUMMARY_LENGTH },
        cols: '200', rows: '5' } %>

    <% elsif @entry.format == 'image' %>
      
      <!-- === IMAGE UPLOAD === -->

      <%= f.input :uploaded_image_key, as: :hidden %>

      <div class="control-group image_upload_button">
        <label class="optional control-label">Upload an Image</label>
        <div class="controls">
          <% if @entry.uploaded_image_key.blank? %> 
            <a href="#" class="btn btn-success btn-large" id="select-image-file">
              <i class="fa fa-file-image-o"></i>
              Select an image file
            </a>
          <% else %> 
            <a href="#" class="btn btn-large disabled" id="image-uploaded">
              <% thumbnail_src = \
                "#{ENV['s3_asset_url']}/#{ENV['s3_bucket_name']}/#{@entry.uploaded_image_key}" %>
              <img src="<%= thumbnail_src %>" class="thumbnail"/>
              
              <i class='fa fa-check'></i>
            </a><br>
            <a href="#" class="btn btn-link" id="select-image-file">
              <i class="fa fa-times-circle"></i>
              Select a different image
            </a>
          <% end %> 
        </div>
      </div>

      <% if @entry.uploaded_image_key %> 
        <!-- Don't show this until the file is uploaded -->
        <%= f.input :summary, as: :text, label: 'Caption (Optional)', 
          input_html: { data: {
          :'character-count' => true, :'max-length' => Entry::MAX_SUMMARY_LENGTH },
          cols: '200', rows: '5' } %>
      <% end %>

      <script type="text/javascript">
        $(document).ready(function() {

          // Clicking the pretty button clicks on the file input element instead
          $("#select-image-file").click(function(e) {
            $("#s3_direct_uploader_direct_uploaded_image").click();
            e.preventDefault();
          });
          
          // Update the display of the button when the file input element changes
          $("#s3_direct_uploader_direct_uploaded_image").change(function() {
            if ($(this).val()) {
              $("#image-upload-spinner").fadeIn();
              $("#uploaded_image_form").submit();
            }
          });

        });
      </script>

    <% else %>
      
      <!-- === FREE TEXT RESPONSE === -->

      <%= f.input :summary, as: :text, label: 'Summary', auto_focus: true, input_html: { data: {
        :'character-count' => true, :'max-length' => Entry::MAX_SUMMARY_LENGTH },
        cols: '200', rows: '5' } %>

      <%= f.input :body, as: :text, label: 'Body', 
        input_html: { class: "huge-text-area rich-text-area" } %>

      <script type="text/javascript">
        $(document).ready(function() { $("#entry_summary").focus() });
      </script>
    
    <% end %>

    <%= f.input :type, as: :hidden %>
    <%= f.input :format, as: :hidden %>
    <%= f.input :parent_tag, as: :hidden %>

  </div>
  
  <div class="form-footer">
    <%
      if (@entry.type == 'validation')
        save_button_text = (@entry.new_record?) ? 'Submit feedback' : 'Update feedback'
      else
        save_button_text = (@entry.new_record?) ? 'Post evidence' : 'Update my evidence'
      end
    %>
    <%= f.button :submit, save_button_text, class: 'btn btn-primary', 
      disabled: ((@entry.format == 'image') && @entry.uploaded_image_key.blank?) %>
    <%= 
      if @entry.new_record?
        link_to "Cancel", [@group, @badge, @log], class: "btn"
      else 
        link_to "Cancel", [@group, @badge, @log, @entry], class: "btn"
      end
    %>
  </div>

<% end %>

<!-- === IMAGE UPLOAD (CONTINUED) - CARRIERWAVE DIRECT FORM === -->

<% if @entry.format == 'image' %>

  <%= direct_upload_form_for(@uploader, html: 
      { id: 'uploaded_image_form', style: 'display: none;'} ) do |u| %>
    <%= u.file_field :direct_uploaded_image %>
  <% end %>

<% end %>