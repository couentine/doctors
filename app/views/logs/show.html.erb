<% 
  provide(:title, "#{@user.name} - #{@badge.name}")
  provide(:include_rich_text, true)
  provide(:include_ob_issuer, true)

  provide(:include_metadata, true)
  if @log.validation_status == 'validated'
    provide(:metadata_title, "#{@badge.name} awarded to #{@user.name}")
    provide(:metadata_description, @badge.summary)
    provide(:metadata_image, group_badge_url(@group, @badge, format: :png) + '?f=wide')
    provide(:metadata_image_width, '1000')
    provide(:metadata_image_height, '500')
    provide(:metadata_site_name, @group.name)
    provide(:metadata_url, group_badge_log_url(@group, @badge, @log))
  else
    provide(:metadata_title, "Badge Progress Log for #{@user.name}")
    provide(:metadata_description, "#{@user.name} joined the #{@badge.name} badge " \
      + "on #{@log.date_started.to_s(:full_date)} and has not yet earned the badge.")
    provide(:metadata_image, @group.logo_url)
    provide(:metadata_site_name, @group.name)
    provide(:metadata_url, group_badge_log_url(@group, @badge, @log))
  end
%>

<!-- === LOG SPECIFIC SCRIPTS === -->

<script type="text/javascript">

  var $root;

  $(document).ready(function() {

    // Register smooth scroll links
    $root = $('html, body');
    $('a.smooth-scroll').click(function() {
        var element = $.attr(this, 'href');
        $root.animate({
            scrollTop: $(element).offset().top - $("header.navbar").height() - 30
        }, 700, function () {
            window.location.hash = element;
        });
        return false;
    });

  });

</script>

<% if @current_user_is_log_owner %>

  <script type="text/javascript">

    $(document).ready(function() {

      if ($(".topic-list-card li a.btn.complete").length == 0) {
        $(".topic-list-card li a.btn.incomplete").first().tooltip({
          title: "Click here to get started",
          placement: "bottom",
          trigger: "manual"
        }).tooltip('show');
      }

    });

  </script>

<% end %>

<% if @current_user_is_log_owner || @badge_list_admin %>

  <!-- === EDIT BADGE MEMBERSHIP MODAL === -->

  <div id="log-visibility" class="modal hide fade" tabindex="-1" role="dialog" 
   aria-labelledby="mimm-label" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
      <h3 id="mimm-label">Edit your badge membership</h3>
    </div>

    <div class="modal-body">
      <div class="bl-modal-form">
        <div class="form-body">
          <%= simple_form_for [@group, @badge, @log], method: :put,
            html: {id: 'log-visibility-form', class: 'form-horizontal'} do |f| %>

            <%= f.input :show_on_profile, as: :radio_buttons, 
              collection: [[true, 'Visible on Badge List profile'] , \
              [false, "Must have link <p class='text-success'><small>(Hidden from profile, but shareable via direct link)</small></p>".html_safe]],
              label_method: :last, value_method: :first, 
              label: 'Should this badge be visible on your Badge List user profile?' %>

            <% if @can_award_badge %>
              <%= f.input :receive_validation_request_emails, as: :select, include_blank: false,
                collection: [[true, 'Yes'], [false, 'No']], label_method: :last, 
                value_method: :first, label: 'Receive feedback request emails?',
                hint: "Feedback request emails are sent automatically whenever a #{@learner} " \
                  + "completes all of the badge requirements." %>
            <% end %>

            <% 
              if @group.private? 
                private_text = 'This will break Mozilla compatibility'
              else
                private_text = 'Only available for private learning grouups'
              end 
            %>
            
            <%
              if @log.validation_status == 'validated'
                privacy_label = "Can other people see your #{@badge.progress_log}?"
              else
                privacy_label = "After you earn the badge your #{@badge.progress_log} will be"
              end
            %>

            <h4>Dangerous Stuff</h4>

            <div class="control-group">
              <label class="control-label" for="delete-log">
                Delete <%= @badge.progress_log %> and resign badge membership
              </label>
              <div class="controls">
                <%= link_to "Delete your #{@badge.progress_log}", [@group, @badge, @log], title: "Careful!",
                  method: :delete, id: "delete-log", class: 'btn btn-danger brn-large', 
                  data: { confirm: "Warning: This can't be undone. Are you absolutely sure you want to"\
                  + " permanently delete your #{@badge.progress_log}?", toggle: 'tooltip', 
                  placement: 'bottom' } %>
                
              </div>
            </div>

          <% end %>
         
         </div>        
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn" aria-hidden="true" 
       onclick="$('#log-visibility-form').submit();">
        Save
      </button>
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
  </div>

<% end %>

<% if @show_sharing %>

  <!-- === BADGE SHARING MODALS === -->

  <%= render 'shared/badge_sharing_modals' %>

<% end %>


<!-- === PAGE HEADER === -->

<% 
  show_validations = !@validations.empty? || (@log.validation_status == 'validated') \
        || (@log.validation_status == 'requested') || !@show_progress
%>

<div class="row add-top-margin">
  <div class="span12">
    <div class="header-bar log-header-bar">
      <table class="info-table">
        <tbody>
          <tr>
            <td class="left-image with-right-image">
              <%= link_to image_tag(group_badge_path(@group, @badge, format: :png)), 
                [@group, @badge], title: 'View badge' %>
            </td>
            <td class="left-panel with-right-image hidden-phone">
              <h1><%= link_to @badge.name, [@group, @badge], title: 'View badge' %></h1>
              <h2>
                <%= link_to @group.url_with_caps, @group, 
                  title: @group.name %>/<%= link_to @badge.url_with_caps, [@group, @badge], 
                  title: "View badge" %>
              </h2>
              <h3>
                <%= @badge.summary %>
              </h3>
            </td>
            
            <% has_footer = @current_user_is_log_owner || @can_award_badge || @badge_list_admin %>
            <td class="separator hidden-phone <%= (has_footer) ? 'with-footer' : '' %>">
              <span>&nbsp;</span>
            </td>
            
            <td class="right-panel with-right-image ">
              <h1><%= link_to @user.name, @user, title: 'View badge profile' %></h1>
              <h2>
                <%= 
                  if @log.validation_status == 'validated'
                    "<i class='fa fa-trophy'></i> #{@Expert}".html_safe
                  else
                    @Learner
                  end
                %>
              </h2>  
              <h3>
                <i class="fa fa-clock-o"></i>
                <%= 
                  if @log.validation_status == 'validated'
                    "Awarded badge on #{@log.date_issued.to_s(:full_date)}"
                  else
                    "Joined badge on #{@log.date_started.to_s(:full_date)}"
                  end
                %>
              </h3>
              <% if @log.validation_status == 'requested' %>
                <h3><span class="text-color primary-medium">
                  <i class="fa fa-flag-checkered"></i>
                  Requested feedback on <%= @log.date_requested.to_s(:full_date) %>
                </span></h3>
              <% end %>
            </td>
            
            <td class="right-image with-left-image">
              <span class="header-image">
                <a href="<%= user_path(@user) %>" title="View user profile">
                  <%= gravatar_for @user, size: 150, class: "img-circle" %>
                </a>
              </span>
            </td>
          </tr>

          <% if has_footer %>
            <tr class="footer-row <%= (@show_sharing) ? 'highlight-tertiary' : '' %>">
              <td colspan="5">
                <span class="label-text">
                  <% if @show_sharing %>
                    You've been awarded this badge and 
                    <% if @log.show_on_profile %>
                      it's visible on your 
                      <%= link_to 'badge profile', @user, title: 'View your badge profile' %>.
                    <% else %>
                      it's hidden from your 
                      <%= link_to 'badge profile', @user, title: 'View your badge profile' %>.
                    <% end %>
                  <% elsif @current_user_is_log_owner %>
                    This is your <%= @badge.progress_log %>.
                  <% elsif @can_award_badge %>
                    You're a badge awarder.
                  <% end %>
                </span>
                
                <ul class="action-list">
                  <% if @show_sharing %>
                    <li>
                      <%= link_to '<i class="fa fa-share-alt"></i> Share the badge'.html_safe, 
                        '#badge-sharing', id: 'share-badge', class: 'btn btn-small', 
                        data: { toggle: 'modal' } %>
                    </li>
                  <% end %>

                  <% if @can_award_badge && !@current_user_is_log_owner && @validation.nil? %>
                    <li>
                      <% if @log.validation_status == 'requested' %>
                        <%= link_to "<i class='fa fa-check-square-o'></i> Add feedback".html_safe,
                        new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation'),
                        class: 'btn btn-small' %>
                      <% else %>
                        <%= link_to "<i class='fa fa-shield'></i> Award badge".html_safe,
                        new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation'),
                        class: 'btn btn-small' %>
                      <% end %>
                    </li>
                  <% end %>

                  <% if @current_user_is_log_owner || @badge_list_admin %>
                    <li>
                      <a href="#log-visibility" tabindex="-1" data-toggle="modal" 
                          class="btn btn-small">
                        <i class="fa fa-pencil"></i> 
                        Edit badge membership
                      </a>
                    </li>
                    <% if @log.validation_status == 'requested' %>
                      <li>
                        <%= link_to "<i class='fa fa-flag'></i> ".html_safe \
                          + "Withdraw feedback request".html_safe,
                          group_badge_log_path(@group, @badge, @log, 
                          log: { date_withdrawn: Time.now }), method: :put, class: 'btn btn-small',
                          data: { confirm: "Are you sure you want to withdraw your request "\
                          + "for feedback on your progress log? \n\nTIP: After withdrawing your "\
                          + "request, #{@experts} will still be able to add "\
                          + "feedback but you will no longer be highlighted as a requester." } %>
                      </li>
                    <% elsif @log.validation_status != 'validated' %>
                      <li>
                        <%= link_to "<i class='fa fa-flag-checkered'></i> ".html_safe \
                          + "Request feedback".html_safe, group_badge_log_path(@group, @badge, 
                          @log, log: { date_requested: Time.now }), method: :put, 
                          class: 'btn btn-small', data: 
                          { confirm: "Are you sure you want to send a request to all "\
                          + "of the #{@experts} asking for them to validate your progress log?" } %>
                      </li>
                    <% end %>
                  <% end %>


                </ul>
              </td>
            </tr>
          <% end %>

        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- === FEEDBACK === -->

<% if show_validations %>
  
  <div class="row">
    <div class="span12">
      <div class="tab-header">

        <% if @current_user_is_log_owner %>
          <% if !@validation.nil? %>
            <%= link_to "<i class='fa fa-pencil'></i> Update self endorsement".html_safe,
              edit_group_badge_log_entry_path(@group, @badge, @log, @validation), 
              class: 'btn btn-small' %>
          <% end %>
        <% elsif @can_award_badge %>
          <% if @validation.nil? %>
            <%= link_to "<i class='fa fa-check-square-o'></i> Add feedback".html_safe,
              new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation'), 
              class: 'btn btn-small' %>
          <% else %>
            <%= link_to "<i class='fa fa-pencil'></i> Update your feedback".html_safe,
              edit_group_badge_log_entry_path(@group, @badge, @log, @validation), 
              class: 'btn btn-small' %>
          <% end %>
        <% end %>

        <% if @log.validation_status == 'requested' %>
          <span class="badge badge-warning collapse-when-small">
            Feedback requested <%= @log.date_requested.to_s(:full_date) %>
          </span>
          <span class="badge badge-warning show-when-small">
            Requested <%= @log.date_requested.to_s(:short_date) %>
          </span>
        <% end %>

        <h2 class="collapse-when-small">Endorsements &amp; Feedback</h2>
        <h2 class="show-when-small">Feedback</h2>
      
      </div>
    </div>
  </div>
    
  <% if @validations.empty? %>

    <div class="row">
      <div class="well span7 offset2">
        <h3>No feedback yet...</h3>
        <p>
          <% if @can_award_badge %>
            This <%= @learner %> needs feedback! To add your feedback, click the button
            below and let the <%= @learner %> know whether or not your believe they have mastered
            the badge.<br><br>
            <%= link_to "<i class='fa fa-check-square-o'></i> Add feedback".html_safe,
              new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation'), 
              class: 'btn btn-success' %>
          <% elsif @current_user_is_log_owner %>
            Once <%= @experts %> weigh in on your progress log, their feedback will appear here!
          <% else %>
            This progress log hasn't yet been validated by any <%= @experts %>.
          <% end %>
        </p>
      </div>
    </div>

  <% else %>

    <div class="row">
      <div class="span12" data-bl-dyncol="parent" data-bl-dyncol-group="validations" 
      data-bl-dyncol-width="12">
        <%= render @validations, date_format: :ago, group: @group, badge: @badge, log: @log, 
          user: @user %>
      </div>
    </div>

  <% end %>

<% end %>

<% if @show_progress && (!@requirements.blank? || @current_user_is_log_owner) %>

  <!-- === EVIDENCE === -->

  <% if !@requirements.blank? %>

    <!-- === TABLE OF CONTENTS === -->

    <div class="row add-top-margin">
      <div class="span12">
        <div class="tab-header merge-with-card">
          <% if @current_user_is_log_owner %>
            <h2>Your Posted Evidence</h2>
          <% else %>
            <h2>Evidence Posted by <%= @user.name %></h2>
          <% end %>
        </div>
      </div>
    </div>

    <div class="row" id="topic-list-row">
      <div class="span12">
        <div class="info-card text-card topic-list-card">
          <ul>
            <% requirements_complete = @log.requirements_complete(@requirements) %>
            <% @requirements.each do |tag| %>
              <%
                if requirements_complete[tag.id]
                  icon_text = "<i class='fa fa-check-square-o'></i>"
                  button_class = "complete"
                else
                  icon_text = "<i class='fa fa-square-o'></i>"
                  button_class = "incomplete"
                end
              %>
              <li>
                <a href="#t-<%= tag.name %>" class="smooth-scroll">
                  <%= "#{icon_text} #{tag.display_name}".html_safe %>
                </a>
                <% if @current_user_is_log_owner %>
                  <%= link_to "<i class='fa #{tag.format_icon}'></i> ".html_safe \
                    + "Post #{tag.format.to_s.capitalize}", \
                    new_group_badge_log_entry_path(@group, @badge, @log, \
                    tag: tag.name_with_caps), class: "btn btn-mini #{button_class}" %>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
    
    <!-- === ACTUAL EVIDENCE === -->

    <% @log.posts_by_topic.each do |topic_item| %>
      <% if @current_user_is_log_owner                        \
        || topic_item['tag'].nil?                              \
        || (topic_item['tag'].privacy == 'public')              \
        || ((topic_item['tag'].privacy == 'private')             \
          && (@current_user_is_member || @current_user_is_admin)) \
        || ((topic_item['tag'].privacy == 'secret')                \
          && (@current_user_is_admin                                \
            || ((@badge.awardability == 'experts') && @current_user_is_expert)))
      %>

        <div class="row add-top-margin" 
            id="t-<%= (topic_item['tag']) ? topic_item['tag'].name : 'etc' %>">
          <div class="span12">
            <div class="tab-header">
              <% if @current_user_is_log_owner %>
                <%
                  if topic_item['tag']
                    format_icon = topic_item['tag'].format_icon
                    format_text = topic_item['tag'].format
                  else
                    format_icon = 'fa-pencil'
                    format_text = 'text'
                  end
                %>
                <%= link_to "<i class='fa #{format_icon}'></i> ".html_safe \
                  + "Post #{format_text.capitalize}",
                  new_group_badge_log_entry_path(@group, @badge, @current_user_log, 
                    tag: (topic_item['tag']) ? topic_item['tag'].name : '' ), 
                  class: 'btn btn-small' %>
              <% end %>

              <h2>
                <%
                  if topic_item['tag']
                    topic_text = topic_item['tag'].display_name
                    if topic_item['entries'].blank?
                      icon_text = "<i class='fa fa-square-o'></i>"
                    else
                      icon_text = "<i class='fa fa-check-square-o'></i>"
                    end
                  else
                    topic_text = 'Etcetera'
                    icon_text = "<i class='fa fa-simplybuilt'></i>"
                  end
                %>
                <%= link_to "#{icon_text} #{topic_text}".html_safe, \
                  [@group, @badge, topic_item['tag']] %>
              </h2>
            </div>
          </div>
        </div>

        <div class="row">
          
          <% if topic_item['entries'].blank? %>

            <div class="well span7 offset2 gray empty">
              <h3>No evidence submitted for this requirement.</h3>
            </div>

          <% else %>

            <div class="span12">

              <%= render topic_item['entries'], date_format: :ago, group: @group, badge: @badge,
                log: @log, user: @user %>

            </div>
          
          <% end %>

        </div>

      <% end %>
    <% end %>

  <% else # NOTE: In this case, you can only see this section if you're the log owner. %>

    <div class="row">
      <div class="well span7 offset2 gray empty">
        <h4>This badge doesn't have any requirements yet!</h4>
        <p>
          You won't be able to post learning evidence until the badge creators add some
          requirements to the badge.
        </p>
      </div>
    </div>

  <% end %>

<% end %>

  