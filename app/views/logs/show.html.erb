<% 
  provide(:title, "#{@user.name} - #{@badge.name}")
  provide(:show_subheader, true)
  provide(:subheader_image, group_image_url_for(@group)) 
  provide(:include_rich_text, true)
  provide(:include_ob_issuer, true)
%>

<% content_for :subheader_links do %>
  <li>
    <%= link_to @group.url_with_caps, @group %>
    <span class="divider">/</span>
  </li>
  <li>
    <%= link_to @badge.url_with_caps, [@group, @badge] %>
    <span class="divider">/</span>
  </li>
  <li class="active">
    u
    <span class="divider">/</span>
    <%= @user.username_with_caps %>
  </li>
<% end %>

<% if @current_user_is_expert || @current_user_is_learner || @badge_list_admin %>
  <% content_for :subheader_actions do %>

    <% if !@current_user_is_log_owner && !@current_user_log.nil? %>
      <li  class="collapsible">
        <%= link_to "<i class='icon-user icon-white'></i> View Your #{@badge.log.capitalize}".html_safe, 
            [@group, @badge, @current_user_log] %>
        <% if (@current_user_is_expert && @show_progress) || @badge_list_admin %>
          <span class="divider">|</span>
        <% end %>
      </li>
    <% end %>

    <% if (@current_user_is_log_owner || @current_user_is_expert) && @show_progress %>
      <li class="collapsible">
        <% if @current_user_is_log_owner %>
          <%= link_to '<i class="fa fa-comment"></i> New Post'.html_safe, 
            new_group_badge_log_entry_path(@group, @badge, @log), id: 'new-post' %>
          <span class="divider">|</span>
        <% else %>
          <%= link_to "<i class='icon-plus-sign icon-white'></i> Post to This Log".html_safe,
            new_group_badge_log_entry_path(@group, @badge, @log) %>
          <% if @validation.nil? || @badge_list_admin %>
            <span class="divider">|</span>
          <% end %>
        <% end %>
      </li>
    <% end %>

    <% if @show_sharing %>
      <li class="collapsible">
        <%= link_to '<i class="fa fa-share"></i> Share Badge'.html_safe, '#badge-sharing', 
          id: 'share-badge', data: { toggle: 'modal' } %>
        <span class="divider">|</span>
      </li>
    <% end %>

    <% if @current_user_is_expert && !@current_user_is_log_owner && @validation.nil? %>
      <li class="collapsible">
        <% if @log.validation_status == 'requested' %>
          <%= link_to "<i class='icon-check icon-white'></i> Add Your Expertise".html_safe,
            new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation') %>
        <% else %>
          <%= link_to "<i class='fa fa-shield'></i> Award Badge".html_safe,
            new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation') %>
        <% end %>

        <% if @badge_list_admin %>
          <span class="divider">|</span>
        <% end %>
      </li>
    <% end %>

    <% if @current_user_is_log_owner || @badge_list_admin %>
      <li class="collapsible">
        <div class="dropdown">
          <a href="#" class="dropdown-toggle" id="dropdown-subheader-settings" 
            role="button" data-toggle="dropdown" data-target="#">
            Log Settings
            <i class="icon-cog icon-white"></i>
            <b class="caret"></b>
          </a>
          <ul class="dropdown-menu pull-right" role="menu" 
            aria-labelledby="dropdown-subheader-settings">
            <li>
              <a href="#log-visibility" tabindex="-1" data-toggle="modal">
                <i class="icon-pencil"></i> 
                Change log visiblity &amp; membership
              </a>
            </li>
            <% if @log.validation_status == 'requested' %>
              <li>
                <%= link_to "<i class='icon-flag'></i>Withdraw validation request".html_safe,
                  group_badge_log_path(@group, @badge, @log, log: { date_withdrawn: Time.now }), 
                  method: :put, data: { confirm: "Are you sure you want to withdraw your request "\
                  + "for validation of your progress log? \n\n"\
                  + "TIP: After withdrawing your request, #{@experts} will still be able to add "\
                  + "validation but you will no longer be highlighted as a requester." } %>
              </li>
            <% elsif @log.validation_status != 'validated' %>
              <li>
                <%= link_to "<i class='fa fa-flag-checkered'></i> Request validation".html_safe,
                  group_badge_log_path(@group, @badge, @log, log: { date_requested: Time.now }), 
                  method: :put, data: { confirm: "Are you sure you want to send a request to all "\
                  + "of the #{@experts} asking for them to validate your progress log? \n\n"\
                  + "TIP: Before submitting your request it's a good idea to update "\
                  + "your personal profile and post final evidence to your progress log." } %>
              </li>
            <% end %>
          </ul>
        </div>
      </li>
    <% end %>

  <% end %>
<% end %>

<!-- === LOG SPECIFIC SCRIPTS === -->

<script type="text/javascript">

  $(document).ready(function() {
    
    <% if @show_sharing %>
      
      var assertionURL = "<%= @log.assertion_url %>";

      $('#export-to-backpack').click(function() {
        console.log("Assertion URL = " + assertionURL);
        $('#badge-sharing').modal('hide');
        OpenBadges.issue([assertionURL], function(errors, successes) {
          if ((errors != null) && (errors.length > 0) && (errors[0].reason != 'DENIED')) {
            $('#badge-sharing-error').modal('show');
            $('#badge-sharing-error-text').html("Assertion URL = " + errors[0].url 
              + ", Reason = " + errors[0].reason);
          }
        });
      });

    <% end %>

    <% if @show_sharing && @first_view_after_issued %>

      $("#share-badge").popover({
        content: "<a class='pull-right' href='#' onclick=\"$('#share-badge').popover('hide')\" "
          + "title='Dismiss this message'><i class='fa fa-times'></i></a> "
          + "You've been awarded the badge, congratulations!<br><br>"
          + "When you're ready, click here to share your achievement.",
        placement: "bottom",
        trigger: "manual",
        container: "header",
        html: true
      }).popover("show");

    <% elsif @current_user_is_log_owner && (@page_view_count == 0) && @show_progress %>

      $("#new-post").popover({
        content: "<a class='pull-right' href='#' onclick=\"$('#new-post').popover('hide')\" "
          + "title='Dismiss this message'><i class='fa fa-times'></i></a> "
          + "When you’re ready, click here to post to your progress log.",
        placement: "bottom",
        trigger: "manual",
        container: "header",
        html: true
      }).popover("show");

    <% end %>

  });

</script>

<% if @current_user_is_log_owner || @badge_list_admin %>

  <!-- === EDIT LOG VISIBILITY MODAL === -->

  <div id="log-visibility" class="modal hide fade" tabindex="-1" role="dialog" 
   aria-labelledby="mimm-label" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="mimm-label">Edit progress log visiblity</h3>
    </div>

    <div class="modal-body">
      <div class="bl-modal-form">
        <div class="form-body">
          <%= simple_form_for [@group, @badge, @log], method: :put,
            html: {id: 'log-visibility-form', class: 'form-horizontal'} do |f| %>

            <%= f.input :show_on_profile, as: :radio_buttons, 
              collection: [[true, 'Visible on Badge List profile'] , \
              [false, "Must have link <p class='text-success'><small>(Hidden from profile, but shareable via direct link)</small></p>".html_safe]],
              label_method: :last, value_method: :first, 
              label: 'Should this badge be visible on your Badge List user profile?' %>

            <% 
              if @group.private? 
                private_text = 'This will break Mozilla compatibility'
              else
                private_text = 'Only available for private learning grouups'
              end 
            %>
            
            <%
              if @log.validation_status == 'validated'
                privacy_label = "Can other people see your #{@badge.progress_log}?"
              else
                privacy_label = "After you earn the badge your #{@badge.progress_log} will be"
              end
            %>

            <% if @group.private? %>
              <%= f.input :private_log, as: :radio_buttons, collection: [[false, 'Public'] , \
                [true, "Private <p class='text-error'><small>(#{private_text})</small></p>".html_safe]],
                label_method: :last, value_method: :first,
                label: privacy_label %>
            <% else %>
              <%= f.input :private_log, as: :radio_buttons, collection: [[false, 'Public'] , \
                [true, "Private <p class='text-error'><small>(#{private_text})</small></p>".html_safe]],
                label_method: :last, value_method: :first, disabled: true,
                label: privacy_label %>
            <% end %>
                

            <h4>Dangerous Stuff</h4>

            <div class="control-group">
              <label class="control-label" for="delete-log">
                Delete <%= @badge.progress_log %> and resign badge membership
              </label>
              <div class="controls">
                <%= link_to "Delete your #{@badge.progress_log}", [@group, @badge, @log], title: "Careful!",
                  method: :delete, id: "delete-log", class: 'btn btn-danger brn-large', 
                  data: { confirm: "Warning: This can't be undone. Are you absolutely sure you want to"\
                  + " permanently delete your #{@badge.progress_log}?", toggle: 'tooltip', 
                  placement: 'bottom' } %>
                
              </div>
            </div>

          <% end %>
         
         </div>        
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn" aria-hidden="true" 
       onclick="$('#log-visibility-form').submit();">
        Save
      </button>
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
  </div>

<% end %>

<% if @show_sharing %>

  <!-- === BADGE SHARING MODAL === -->

  <div id="badge-sharing" class="modal hide fade" tabindex="-1" role="dialog" 
   aria-labelledby="mimm-label" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="mimm-label">Share your badge achievement</h3>
    </div>

    <div class="modal-body">
      <p>
        You've earned the badge, congratulations! Now you can share your accomplishment by exporting
        the badge to your Mozilla Backpack. Once the badge is in your backpack you will be able to 
        display it alongside other Open Badges and share it out to other social networks.
      </p>
      <p>&nbsp;</p>
      <p>
        <a href="#" id="export-to-backpack" class="btn btn-large btn-success">
          Export this badge to your Mozilla Backpack
        </a>
      </p>
    </div>

    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
  </div>

  <!-- === BADGE SHARING ERROR MODAL === -->

  <div id="badge-sharing-error" class="modal hide fade" tabindex="-1" role="dialog" 
   aria-labelledby="mimm-label" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="mimm-label">Oh no!</h3>
    </div>

    <div class="modal-body">
      <p>
        It looks like there was an error sharing your badge. This could be due to a problem with
        Mozilla's system or it could be due to a bug in Badge List. We humbly apologize for the 
        inconvenience and ask you to try again later.
      </p>
      <p>
        In the meantime please feel free to send an email to <b>help@badgelist.com</b> if you'd 
        like our help resolving this issue. (Be sure to include the error text below.) Thanks!
      </p>
      <p>
        <b>Error Text:</b> 
        <span id="badge-sharing-error-text"></span>
      </p>
    </div>

    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
  </div>

<% end %>


<!-- === PAGE HEADER === -->

<% 
  show_profile = @log.has_profile? || @current_user_is_log_owner 
  show_validations = !@validations.empty? || (@log.validation_status == 'validated') \
        || (@log.validation_status == 'requested') || !@show_progress
  show_tabs = (show_profile && show_validations) \
    || (show_profile && @show_progress) \
    || (show_validations && @show_progress)
%>

<div class="row add-top-margin">
  <div class="span12">
    <div class="header-card log-header-card">
      <div class="white-background <%= (show_tabs) ? '' : 'no-tabs' %>">&nbsp;</div>

      <div class="primary-header span6">
        <span class="header-image">
          <%= link_to image_tag(group_badge_path(@group, @badge, format: :png)), 
            [@group, @badge], title: 'View badge' %>
        </span>
        <span class="header-text">
          <h1><%= link_to @badge.name, [@group, @badge], title: 'View badge' %></h1>
          <h2>
            <%= link_to @group.url_with_caps, @group, 
              title: @group.name %>/<%= link_to @badge.url_with_caps, [@group, @badge], 
              title: "View badge" %>
          </h2>
          <h3>
            <%= @badge.summary %>
          </h3>
        </span>
      </div>

      <div class="secondary-header span6 <%= (show_tabs) ? '' : 'no-tabs' %>">
        <span class="header-image">
          <a href="<%= user_path(@user) %>" title="View user profile">
            <%= gravatar_for @user, size: 150, class: "img-circle" %>
          </a>
        </span>
        <span class="header-text">
          <h1><%= link_to @user.name, @user, title: 'View Badge List user profile' %></h1>
          <h2>
            <%= 
              if @log.validation_status == 'validated'
                "#{@Expert} <i class='fa fa-trophy'></i>".html_safe
              else
                @Learner
              end
            %>
          </h2>  
          <h3>
            <%= 
              if @log.validation_status == 'validated'
                "Awarded badge on #{@log.date_issued.to_s(:full_date)}"
              else
                "Joined badge on #{@log.date_started.to_s(:full_date)}"
              end
            %>
          </h3>
          <% if @log.validation_status == 'requested' %>
            <h3><span class="text-color primary-medium">
              <i class="fa fa-flag-checkered"></i>
              Requested validation on <%= @log.date_requested.to_s(:full_date) %>
            </span></h3>
          <% end %>
        </span>
      </div>

      <% if show_tabs \
        && (@log.public? || @current_user_is_admin || @current_user_is_member || @badge_list_admin) %>

        <div class="card-tabs">
          <ul class="nav nav-tabs">
            <% if show_profile %>
              <li class="active"><a href="#profile" data-toggle="tab">Profile</a></li>
            <% end %>

            <% if show_validations %>
              <li class="<%= (show_profile) ? '' : 'active' %>">
                <a href="#validations" data-toggle="tab">Validation</a>
              </li>
            <% end %>
            
            <% if @show_progress %>
              <li class="<%= (!show_profile && !show_validations) ? 'active' : '' %>">
                <a href="#posts" data-toggle="tab">Posts</a>
              </li>
            <% end %>
          </ul>
        </div>

      <% end %>

    </div>
  </div>
</div>


<% if @log.public? || @current_user_is_admin || @current_user_is_member || @badge_list_admin %>

  <!-- === TAB CONTENT === -->

  <div class="tab-content">

    <% if show_profile %>

      <!-- === PROFILE TAB === -->

      <div class="tab-pane active" id="profile">

        <% if !@log.has_profile? %>
        
          <!-- === PROFILE VISIBILITY ALERT === -->

          <div class="alert alert-gray">
            <i class="fa fa-eye-slash"></i> 
            <b>Profile Tab Currently Hidden:</b> 
            Until you add content to your profile below, the Profile tab will be hidden from other people.
          </div>

        <% end %>

        <% if @current_user_is_log_owner || @badge_list_admin %>
          <div class="row">
            <div class="span12">

            <% 
              you = (@current_user_is_log_owner) ? 'you' : @user.name
              your = (@current_user_is_log_owner) ? 'your' : "#{@user.name}'s"
            %>

              <div class="tab-header">

                <% if @current_user_is_log_owner || @badge_list_admin %>
                  <a tabindex="-1" href="#" class="btn btn-small" data-toggle="custom" 
                    id="edit-profile" data-hide="#edit-profile,#profile-row" 
                    data-show="#profile-inline-form" data-focus="#log_wiki">

                    <i class="fa fa-pencil"></i> Edit <%= your %> profile
                  </a>
                <% end %>
              
                <h2>Badge Profile</h2>
                <h3 class="collapse-when-small">
                  <i class="fa fa-key"></i> Only editable by <%= you %>
                </h3>
              
              </div>

            </div>
          </div>
        <% end %>

        <div class="row" id="profile-row">
          
          <% if @log.has_profile? %>

            <div class="span12">
              <% @log.wiki_sections.each do |section_text| %>
                <div class="info-card text-card">
                  <%= section_text.html_safe %>
                </div>
              <% end unless @log.wiki_sections.nil? %>
            </div>

          <% else %>

            <div class="well gray span7 offset2">
              <h3>Add a badge profile here</h3>
              <p>
                If you like, you can use this area to share some info about yourself and your 
                relationship to this badge. 
                (The profile tab is hidden from other people if you don't fill it in.)
              </p>
            </div>

          <% end %>

        </div>

        <% if @current_user_is_log_owner %>

          <!-- === EDIT PROFILE INTERFACE === -->

          <div class="bl-inline-form" id="profile-inline-form" style="display: none">              
            <%= simple_form_for [@group, @badge, @log], id: 'edit-profile-form' do |f| %>

              <div class="form-body">
                <%= f.input :wiki, as: :text, label: 'Edit Badge Profile', 
                  input_html: { class: "huge-text-area rich-text-area" } %>
              </div>

              <div class="form-footer">
                <%= f.button :submit, 'Save changes', class: 'btn btn-primary' %>
                <a class="btn" data-toggle="custom"  data-hide="#profile-inline-form" 
                  data-show="#edit-profile,#profile-row">Cancel</a>
              </div>

            <% end %>

          </div>

        <% end %>


      </div>

    <% end %>

    <!-- === VALIDATIONS TAB === -->

    <% if show_validations %>

      <div class="tab-pane <%= (show_profile) ? '' : 'active' %>" id="validations">
        
        <div class="row">
          <div class="span12">
            <div class="tab-header">

              <% if @current_user_is_log_owner %>
                <% if @validation.nil? %>
                  <%= link_to "<i class='icon-check'></i> Add self validation".html_safe,
                    new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation'), 
                    class: 'btn btn-small' %>
                <% else %>
                  <%= link_to "<i class='icon-pencil'></i> Update self validation".html_safe,
                    edit_group_badge_log_entry_path(@group, @badge, @log, @validation), 
                    class: 'btn btn-small' %>
                <% end %>
              <% elsif @current_user_is_expert %>
                <% if @validation.nil? %>
                  <%= link_to "<i class='icon-check'></i> Add your expertise".html_safe,
                    new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation'), 
                    class: 'btn btn-small' %>
                <% else %>
                  <%= link_to "<i class='icon-pencil'></i> Update your validation".html_safe,
                    edit_group_badge_log_entry_path(@group, @badge, @log, @validation), 
                    class: 'btn btn-small' %>
                <% end %>
              <% end %>

            
              <% if @log.validation_count < @badge.current_validation_threshold %>
                <span class="badge badge-success collapse-when-small">
                  Current validation threshold is <%= @badge.current_validation_threshold %>
                </span>
                <span class="badge badge-success show-when-small">
                  Threshold is <%= @badge.current_validation_threshold %>
                </span>
              <% end %>

              <% if @log.validation_status == 'requested' %>
                <span class="badge badge-warning collapse-when-small">
                  Validation requested <%= @log.date_requested.to_s(:full_date) %>
                </span>
                <span class="badge badge-warning show-when-small">
                  Requested <%= @log.date_requested.to_s(:short_date) %>
                </span>
              <% elsif @log.validation_status == 'validated' %>
                <span class="badge badge-info collapse-when-small">
                  Badge awarded <%= @log.date_issued.to_s(:full_date) %>
                </span>
                <span class="badge badge-info show-when-small">
                  Awarded <%= @log.date_issued.to_s(:short_date) %>
                </span>
              <% end %>

              <h2 class="collapse-when-small">Validation from Badge <%= @Experts %></h2>
              <h2 class="show-when-small">Validations</h2>
            
            </div>
          </div>
        </div>
          
        <% if @validations.empty? %>

          <div class="row">
            <div class="well span7 offset2">
              <p class="lead">No validations yet...</p>
              <p>
                <% if @current_user_is_expert %>
                  This <%= @learner %> needs validations! To add your expertise, click the button
                  below and let the <%= @learner %> know whether or not your believe they have mastered
                  the badge.<br><br>
                  <%= link_to "<i class='icon-check icon-white'></i> Add your expertise".html_safe,
                    new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation'), 
                    class: 'btn btn-success' %>
                <% elsif @current_user_is_log_owner %>
                  Once <%= @experts %> weigh in on your progress log, their validations will appear here!
                <% else %>
                  This progress log hasn't yet been validated by any <%= @experts %>.
                <% end %>
              </p>
            </div>
          </div>

        <% else %>

          <div class="row">
            <div class="span12" data-bl-dyncol="parent" data-bl-dyncol-group="validations" 
            data-bl-dyncol-width="12">
              <%= render(@validations, show_badge: false, date_format: :full) %>
            </div>
          </div>

        <% end %>

      </div>

    <% end %>

    <% if @show_progress %>

      <!-- === ENTRIES TAB === -->

      <div class="tab-pane <%= (!show_profile && !show_validations) ? 'active' : '' %>" id="posts">
        
        <% if @posts_by_month.blank? %>

          <div class="row">
            <div class="well span7 offset2">
              <p class="lead">No posts yet...</p>
              <p>
                <% if @current_user_is_log_owner %>
                  It's time to get posting!<br>
                  Click the button below to write your first post.<br><br>
                  <%= link_to "<i class='icon-plus icon-white'></i> New post".html_safe,
                    new_group_badge_log_entry_path(@group, @badge, @log), class: 'btn btn-success' %>
                <% elsif @current_user_is_expert %>
                  Looks like <%= @user.name %> hasn't posted anything yet.<br>
                  You can help them out by clicking the button below!<br><br>
                  <%= link_to \
                    "<i class='icon-plus icon-white'></i> Post to this log".html_safe,
                    new_group_badge_log_entry_path(@group, @badge, @log), class: 'btn btn-success' %>
                <% else %>
                  Looks like <%= @user.name %> hasn't posted anything yet.
                <% end %>
              </p>
            </div>
          </div>

        <% else %>

          <div class="row">
            <div class="span12">
              <div class="pagination-header">
                <div class="pagination"><%= paginate @posts %></div>
              </div>
            </div>
          </div>

          <% @posts_by_month.each do |month_item| %>
         
            <div class="row">
              <div class="span12">
                <div class="tab-header">
                  <h2><%= month_item[:label] %></h2>
                </div>
              </div>
            </div>
          
            <div class="row">
              <div class="span12" data-bl-dyncol="parent" 
                data-bl-dyncol-group="posts.<%= month_item[:label].parameterize %>" 
                data-bl-dyncol-width="12">
                  <% entries = month_item[:posts] %>
                  <%= render entries, show_badge: false, date_format: :full if !entries.nil? %>
              </div>
            </div>

          <% end %>

          <div class="row">
            <div class="span12">
              <div class="pagination-footer">
                <div class="pagination"><%= paginate @posts %></div>
              </div>
            </div>
          </div>

        <% end %>
      
      </div>

    <% end %>

  </div>


<% else %>
  
  <div class="row">
    <div class="well span7 offset2">
      <p class="lead">This is a private <%= @badge.progress_log %></p>
      <p>
        The owner of this <%= @badge.log %> has set it to be private.  
        Its contents are only visible to members of the learning group.
      </p>
    </div>
  </div>

<% end %>