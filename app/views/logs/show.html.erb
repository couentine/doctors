<% 
  provide(:title, "#{@user.name} - #{@badge.name}")
  provide(:show_subheader, true)
  provide(:subheader_image, group_image_url_for(@group)) 
  provide(:include_rich_text, true)
  provide(:include_ob_issuer, true)

  provide(:include_metadata, true)
  if @log.validation_status == 'validated'
    provide(:metadata_title, "#{@badge.name} awarded to #{@user.name}")
    provide(:metadata_description, @badge.summary)
    provide(:metadata_image, group_badge_url(@group, @badge, format: :png))
    provide(:metadata_image_width, '500')
    provide(:metadata_image_height, '500')
    provide(:metadata_site_name, @group.name)
    provide(:metadata_url, group_badge_log_url(@group, @badge, @log))
  else
    provide(:metadata_title, "Badge Progress Log for #{@user.name}")
    provide(:metadata_description, "#{@user.name} joined the #{@badge.name} badge " \
      + "on #{@log.date_started.to_s(:full_date)} and has not yet earned the badge.")
    provide(:metadata_image, @group.logo_url)
    provide(:metadata_site_name, @group.name)
    provide(:metadata_url, group_badge_log_url(@group, @badge, @log))
  end
%>

<% content_for :subheader_links do %>
  <li>
    <%= link_to @group.url_with_caps, @group %>
    <span class="divider">/</span>
  </li>
  <li>
    <%= link_to @badge.url_with_caps, [@group, @badge] %>
    <span class="divider">/</span>
  </li>
  <li class="active">
    u
    <span class="divider">/</span>
    <%= @user.username_with_caps %>
  </li>
<% end %>

<% if @current_user_is_expert || @current_user_is_learner || @can_award_badge %>
  <% content_for :subheader_actions do %>

    <% if !@current_user_is_log_owner && !@current_user_log.nil? %>
      <li  class="collapsible">
        <%= link_to "<i class='icon-user icon-white'></i> View Your #{@badge.log.capitalize}".html_safe, 
            [@group, @badge, @current_user_log] %>
        <% if @can_award_badge || @badge_list_admin %>
          <span class="divider">|</span>
        <% end %>
      </li>
    <% end %>

    <% if @can_award_badge && !@current_user_is_log_owner && @validation.nil? %>
      <li class="collapsible">
        <% if @log.validation_status == 'requested' %>
          <%= link_to "<i class='icon-check icon-white'></i> Add Your Expertise".html_safe,
            new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation') %>
        <% else %>
          <%= link_to "<i class='fa fa-shield'></i> Award Badge".html_safe,
            new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation') %>
        <% end %>

        <% if @badge_list_admin %>
          <span class="divider">|</span>
        <% end %>
      </li>
    <% end %>

    <% if @current_user_is_log_owner || @badge_list_admin %>
      <li class="collapsible">
        <div class="dropdown">
          <a href="#" class="dropdown-toggle" id="dropdown-subheader-settings" 
            role="button" data-toggle="dropdown" data-target="#">
            Log Settings
            <i class="icon-cog icon-white"></i>
            <b class="caret"></b>
          </a>
          <ul class="dropdown-menu pull-right" role="menu" 
            aria-labelledby="dropdown-subheader-settings">
            <li>
              <a href="#log-visibility" tabindex="-1" data-toggle="modal">
                <i class="icon-pencil"></i> 
                Edit your badge membership
              </a>
            </li>
            <% if @log.validation_status == 'requested' %>
              <li>
                <%= link_to "<i class='icon-flag'></i>Withdraw validation request".html_safe,
                  group_badge_log_path(@group, @badge, @log, log: { date_withdrawn: Time.now }), 
                  method: :put, data: { confirm: "Are you sure you want to withdraw your request "\
                  + "for validation of your progress log? \n\n"\
                  + "TIP: After withdrawing your request, #{@experts} will still be able to add "\
                  + "validation but you will no longer be highlighted as a requester." } %>
              </li>
            <% elsif @log.validation_status != 'validated' %>
              <li>
                <%= link_to "<i class='fa fa-flag-checkered'></i> Request validation".html_safe,
                  group_badge_log_path(@group, @badge, @log, log: { date_requested: Time.now }), 
                  method: :put, data: { confirm: "Are you sure you want to send a request to all "\
                  + "of the #{@experts} asking for them to validate your progress log?" } %>
              </li>
            <% end %>
          </ul>
        </div>
      </li>
    <% end %>

  <% end %>
<% end %>

<!-- === LOG SPECIFIC SCRIPTS === -->

<script type="text/javascript">

  var $root;

  $(document).ready(function() {

    // Register smooth scroll links
    $root = $('html, body');
    $('a.smooth-scroll').click(function() {
        var element = $.attr(this, 'href');
        $root.animate({
            scrollTop: $(element).offset().top - $("header.navbar").height() - 30
        }, 700, function () {
            window.location.hash = element;
        });
        return false;
    });
    
    <% if @show_sharing %>
      
      var assertionURL = "<%= @log.assertion_url(@group, @badge, @user) %>";

      $('#export-to-backpack').click(function() {
        $('#badge-sharing').modal('hide');
        OpenBadges.issue([assertionURL], function(errors, successes) {
          if ((errors != null) && (errors.length > 0) && (errors[0].reason != 'DENIED')) {
            $('#badge-sharing-error').modal('show');
            $('#badge-sharing-error-text').html("Assertion URL = " + errors[0].url 
              + ", Reason = " + errors[0].reason);
          }
        });
      });

      $('#export-to-embed').click(function() {
        $('#badge-sharing').modal('hide');
        $('#badge-embed').modal('show');
      });

    <% end %>

  });

</script>

<% if @current_user_is_log_owner || @badge_list_admin %>

  <!-- === EDIT BADGE MEMBERSHIP MODAL === -->

  <div id="log-visibility" class="modal hide fade" tabindex="-1" role="dialog" 
   aria-labelledby="mimm-label" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="mimm-label">Edit your badge membership</h3>
    </div>

    <div class="modal-body">
      <div class="bl-modal-form">
        <div class="form-body">
          <%= simple_form_for [@group, @badge, @log], method: :put,
            html: {id: 'log-visibility-form', class: 'form-horizontal'} do |f| %>

            <%= f.input :show_on_profile, as: :radio_buttons, 
              collection: [[true, 'Visible on Badge List profile'] , \
              [false, "Must have link <p class='text-success'><small>(Hidden from profile, but shareable via direct link)</small></p>".html_safe]],
              label_method: :last, value_method: :first, 
              label: 'Should this badge be visible on your Badge List user profile?' %>

            <% if @can_award_badge %>
              <%= f.input :receive_validation_request_emails, as: :select, include_blank: false,
                collection: [[true, 'Yes'], [false, 'No']], label_method: :last, 
                value_method: :first, label: 'Receive validation request emails?',
                hint: "Validation request emails are sent automatically whenever a #{@learner} " \
                  + "completes all of the badge requirements." %>
            <% end %>

            <% 
              if @group.private? 
                private_text = 'This will break Mozilla compatibility'
              else
                private_text = 'Only available for private learning grouups'
              end 
            %>
            
            <%
              if @log.validation_status == 'validated'
                privacy_label = "Can other people see your #{@badge.progress_log}?"
              else
                privacy_label = "After you earn the badge your #{@badge.progress_log} will be"
              end
            %>

            <h4>Dangerous Stuff</h4>

            <div class="control-group">
              <label class="control-label" for="delete-log">
                Delete <%= @badge.progress_log %> and resign badge membership
              </label>
              <div class="controls">
                <%= link_to "Delete your #{@badge.progress_log}", [@group, @badge, @log], title: "Careful!",
                  method: :delete, id: "delete-log", class: 'btn btn-danger brn-large', 
                  data: { confirm: "Warning: This can't be undone. Are you absolutely sure you want to"\
                  + " permanently delete your #{@badge.progress_log}?", toggle: 'tooltip', 
                  placement: 'bottom' } %>
                
              </div>
            </div>

          <% end %>
         
         </div>        
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn" aria-hidden="true" 
       onclick="$('#log-visibility-form').submit();">
        Save
      </button>
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
  </div>

<% end %>

<% if @show_sharing %>

  <!-- === BADGE SHARING MODAL === -->

  <%= render 'shared/badge_sharing_modal' %>

  <!-- === BADGE EMBED MODAL === -->

  <div id="badge-embed" class="modal hide fade" tabindex="-1" role="dialog" 
   aria-labelledby="mimm-label" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="mimm-label">Badge embed code</h3>
    </div>

    <div class="modal-body">
      <p>
        You can display your badge achievement on your blog or on any other website which supports 
        iframes. Just copy and paste the code below.
      </p>
      <pre>
FIXME
      </pre>
    </div>

    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
  </div>

  <!-- === BADGE SHARING ERROR MODAL === -->

  <div id="badge-sharing-error" class="modal hide fade" tabindex="-1" role="dialog" 
   aria-labelledby="mimm-label" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
      <h3 id="mimm-label">Oh no!</h3>
    </div>

    <div class="modal-body">
      <p>
        It looks like there was an error sharing your badge. This could be due to a problem with
        Mozilla's system or it could be due to a bug in Badge List. We humbly apologize for the 
        inconvenience and ask you to try again later.
      </p>
      <p>
        In the meantime please feel free to send an email to <b>help@badgelist.com</b> if you'd 
        like our help resolving this issue. (Be sure to include the error text below.) Thanks!
      </p>
      <p>
        <b>Error Text:</b> 
        <span id="badge-sharing-error-text"></span>
      </p>
    </div>

    <div class="modal-footer">
      <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
  </div>

<% end %>


<!-- === PAGE HEADER === -->

<% 
  show_validations = !@validations.empty? || (@log.validation_status == 'validated') \
        || (@log.validation_status == 'requested') || !@show_progress
%>

<div class="row add-top-margin">
  <div class="span12">
    <div class="header-bar log-header-bar">
      <table class="info-table">
        <tbody>
          <tr>
            <td class="left-image with-right-image">
              <%= link_to image_tag(group_badge_path(@group, @badge, format: :png)), 
                [@group, @badge], title: 'View badge' %>
            </td>
            <td class="left-panel with-right-image hidden-phone">
              <h1><%= link_to @badge.name, [@group, @badge], title: 'View badge' %></h1>
              <h2>
                <%= link_to @group.url_with_caps, @group, 
                  title: @group.name %>/<%= link_to @badge.url_with_caps, [@group, @badge], 
                  title: "View badge" %>
              </h2>
              <h3>
                <%= @badge.summary %>
              </h3>
            </td>
            
            <td class="separator hidden-phone <%= (@show_sharing) ? 'with-footer' : '' %>">
              <span>&nbsp;</span>
            </td>
            
            <td class="right-panel with-right-image ">
              <h1><%= link_to @user.name, @user, title: 'View Badge List user profile' %></h1>
              <h2>
                <%= 
                  if @log.validation_status == 'validated'
                    "<i class='fa fa-trophy'></i> #{@Expert}".html_safe
                  else
                    @Learner
                  end
                %>
              </h2>  
              <h3>
                <i class="fa fa-clock-o"></i>
                <%= 
                  if @log.validation_status == 'validated'
                    "Awarded badge on #{@log.date_issued.to_s(:full_date)}"
                  else
                    "Joined badge on #{@log.date_started.to_s(:full_date)}"
                  end
                %>
              </h3>
              <% if @log.validation_status == 'requested' %>
                <h3><span class="text-color primary-medium">
                  <i class="fa fa-flag-checkered"></i>
                  Requested validation on <%= @log.date_requested.to_s(:full_date) %>
                </span></h3>
              <% end %>
            </td>
            
            <td class="right-image with-left-image">
              <span class="header-image">
                <a href="<%= user_path(@user) %>" title="View user profile">
                  <%= gravatar_for @user, size: 150, class: "img-circle" %>
                </a>
              </span>
            </td>
          </tr>

          <% if @show_sharing %>
            <tr class="footer-row highlight-tertiary">
              <td colspan="5">
                <span class="label-text">
                  You've been awarded this badge.
                </span>
                <ul class="action-list">
                  <li>
                    <%= link_to '<i class="fa fa-share-alt"></i> Share the badge'.html_safe, 
                      '#badge-sharing', id: 'share-badge', class: 'btn btn-small', 
                      data: { toggle: 'modal' } %>
                  </li>
                </ul>
              </td>
            </tr>
          <% end %>

        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- === VALIDATIONS === -->

<% if show_validations %>
  
  <div class="row">
    <div class="span12">
      <div class="tab-header">

        <% if @current_user_is_log_owner %>
          <% if !@validation.nil? %>
            <%= link_to "<i class='icon-pencil'></i> Update self validation".html_safe,
              edit_group_badge_log_entry_path(@group, @badge, @log, @validation), 
              class: 'btn btn-small' %>
          <% end %>
        <% elsif @can_award_badge %>
          <% if @validation.nil? %>
            <%= link_to "<i class='icon-check'></i> Add your expertise".html_safe,
              new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation'), 
              class: 'btn btn-small' %>
          <% else %>
            <%= link_to "<i class='icon-pencil'></i> Update your validation".html_safe,
              edit_group_badge_log_entry_path(@group, @badge, @log, @validation), 
              class: 'btn btn-small' %>
          <% end %>
        <% end %>

        <% if @log.validation_status == 'requested' %>
          <span class="badge badge-warning collapse-when-small">
            Validation requested <%= @log.date_requested.to_s(:full_date) %>
          </span>
          <span class="badge badge-warning show-when-small">
            Requested <%= @log.date_requested.to_s(:short_date) %>
          </span>
        <% end %>

        <h2 class="collapse-when-small">Validation from Badge <%= @Experts %></h2>
        <h2 class="show-when-small">Validations</h2>
      
      </div>
    </div>
  </div>
    
  <% if @validations.empty? %>

    <div class="row">
      <div class="well span7 offset2">
        <h3>No validations yet...</h3>
        <p>
          <% if @can_award_badge %>
            This <%= @learner %> needs validations! To add your expertise, click the button
            below and let the <%= @learner %> know whether or not your believe they have mastered
            the badge.<br><br>
            <%= link_to "<i class='icon-check icon-white'></i> Add your expertise".html_safe,
              new_group_badge_log_entry_path(@group, @badge, @log, type: 'validation'), 
              class: 'btn btn-success' %>
          <% elsif @current_user_is_log_owner %>
            Once <%= @experts %> weigh in on your progress log, their validations will appear here!
          <% else %>
            This progress log hasn't yet been validated by any <%= @experts %>.
          <% end %>
        </p>
      </div>
    </div>

  <% else %>

    <div class="row">
      <div class="span12" data-bl-dyncol="parent" data-bl-dyncol-group="validations" 
      data-bl-dyncol-width="12">
        <%= render @validations, date_format: :ago, group: @group, badge: @badge, log: @log, 
          user: @user %>
      </div>
    </div>

  <% end %>

<% end %>

<% if @show_progress && (!@requirements.blank? || @current_user_is_log_owner) %>

  <!-- === EVIDENCE === -->

  <% if !@requirements.blank? %>

    <!-- === TABLE OF CONTENTS === -->

    <div class="row add-top-margin">
      <div class="span12">
        <div class="tab-header merge-with-card">
          <% if @current_user_is_log_owner %>
            <h2>Your Posted Evidence</h2>
          <% else %>
            <h2>Evidence Posted by <%= @user.name %></h2>
          <% end %>
        </div>
      </div>
    </div>

    <div class="row" id="topic-list-row">
      <div class="span12">
        <div class="info-card text-card topic-list-card">
          <ul>
            <% requirements_complete = @log.requirements_complete(@requirements) %>
            <% @requirements.each do |tag| %>
              <%
                if requirements_complete[tag.id]
                  icon_text = "<i class='fa fa-check-square-o'></i>"
                else
                  icon_text = "<i class='fa fa-square-o'></i>"
                end
              %>
              <li>
                <a href="#t-<%= tag.name %>" class="smooth-scroll">
                  <%= "#{icon_text} #{tag.display_name}".html_safe %>
                </a>
                <% if @current_user_is_log_owner %>
                  <%= link_to "<i class='fa #{tag.format_icon}'></i> ".html_safe \
                    + "Post #{tag.format.to_s.capitalize}", \
                    new_group_badge_log_entry_path(@group, @badge, @log, \
                    tag: tag.name_with_caps), class: 'btn btn-mini' %>
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
    
    <!-- === ACTUAL EVIDENCE === -->

    <% @log.posts_by_topic.each do |topic_item| %>
      <% if @current_user_is_log_owner                        \
        || topic_item['tag'].nil?                              \
        || (topic_item['tag'].privacy == 'public')              \
        || ((topic_item['tag'].privacy == 'private')             \
          && (@current_user_is_member || @current_user_is_admin)) \
        || ((topic_item['tag'].privacy == 'secret')                \
          && (@current_user_is_admin                                \
            || ((@badge.awardability == 'experts') && @current_user_is_expert)))
      %>

        <div class="row add-top-margin" 
            id="t-<%= (topic_item['tag']) ? topic_item['tag'].name : 'etc' %>">
          <div class="span12">
            <div class="tab-header">
              <% if @current_user_is_log_owner %>
                <%
                  if topic_item['tag']
                    format_icon = topic_item['tag'].format_icon
                    format_text = topic_item['tag'].format
                  else
                    format_icon = 'fa-pencil'
                    format_text = 'text'
                  end
                %>
                <%= link_to "<i class='fa #{format_icon}'></i> ".html_safe \
                  + "Post #{format_text.capitalize}",
                  new_group_badge_log_entry_path(@group, @badge, @current_user_log, 
                    tag: (topic_item['tag']) ? topic_item['tag'].name : '' ), 
                  class: 'btn btn-small' %>
              <% end %>

              <h2>
                <%
                  if topic_item['tag']
                    topic_text = topic_item['tag'].display_name
                    if topic_item['entries'].blank?
                      icon_text = "<i class='fa fa-square-o'></i>"
                    else
                      icon_text = "<i class='fa fa-check-square-o'></i>"
                    end
                  else
                    topic_text = 'Etcetera'
                    icon_text = "<i class='fa fa-simplybuilt'></i>"
                  end
                %>
                <%= link_to "#{icon_text} #{topic_text}".html_safe, \
                  [@group, @badge, topic_item['tag']] %>
              </h2>
            </div>
          </div>
        </div>

        <div class="row">
          
          <% if topic_item['entries'].blank? %>

            <div class="well span7 offset2 gray empty">
              <h3>No evidence submitted for this requirement.</h3>
            </div>

          <% else %>

            <div class="span12">

              <%= render topic_item['entries'], date_format: :ago, group: @group, badge: @badge,
                log: @log, user: @user %>

            </div>
          
          <% end %>

        </div>

      <% end %>
    <% end %>

  <% else # NOTE: In this case, you can only see this section if you're the log owner. %>

    <div class="row">
      <div class="well span7 offset2 gray empty">
        <h4>This badge doesn't have any requirements yet!</h4>
        <p>
          You won't be able to post learning evidence until the badge creators add some
          requirements to the badge.
        </p>
      </div>
    </div>

  <% end %>

<% end %>

  