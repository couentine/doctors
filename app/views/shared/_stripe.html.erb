<%
  # This will collect card info from a form with id = 'stripe-form'.
  # Afterwards the code will either populate an input w/ id = 'stripe_token' 
  #   or it will put errror text into an element with class = 'payment-errors'
%>

<script type="text/javascript" src="https://js.stripe.com/v2/"></script>

<script type="text/javascript">
  
  Stripe.setPublishableKey("<%= ENV['stripe_public_key'] %>");

  $(document).ready(function() {
    
    $('#stripe-form').submit(function(e) {
      var $form = $(this);

      $form.find('button').prop('disabled', true);
      $form.find('#stripe-spinner').show();
      $form.find('.error-block').hide().find('.inner').text('');

      Stripe.card.createToken($form, stripeResponseHandler);

      // Prevent the form from submitting with the default action
      e.preventDefault();
    });

  });

  function stripeResponseHandler(status, response) {
    var $form = $('#stripe-form');

    if (response.error) {
      // Show the errors on the form
      $form.find('.error-block').show().find('.inner').text(response.error.message);
      $form.find('button').prop('disabled', false);
      $form.find('#stripe-spinner').hide();
    } else {
      // Insert the token into the form and submit
      var token = response.id;
      $form.find('#stripe_token').val(token);
      $form.get(0).submit();
    }
  };

</script>