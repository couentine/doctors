<% 
  provide(:title, 'Change account info') 
  provide(:include_stripe, true) 
%>

<script>

  var deletedCardId;

  $(document).ready(function() {

    $("a[data-type=delete-card]").click(function(e) {
      deletedCardId = $(this).data("id");
      $("#delete-card-spinner").fadeIn();
      $.ajax({
          url: "/users/card/" + deletedCardId,
          type: "DELETE",
          success: function(response) {
            startPoller(response.poller_id, deleteCardCompleted, deleteCardError);
          },
          error: deleteCardError
      });

      e.preventDefault();
    });

  });

  /* === Stripe polling functionality === */

  function addCardCompleted(poller) {
    var stripe_form = $('#stripe-form');

    if (poller.status == 'successful') {
      $("#add-card-form").slideUp();
      $("#billing-info-row").slideDown();
      $("#credit-card-buttons").slideDown();
      $('#stripe-spinner').hide();
      $("#stripe-form input[type=text]").val("")
      
      var card = poller.data;
      $("#billing-info-row table tbody").append(
        "<tr class='highlight-secondary'>"
          + "<td>" + card.brand + "</td><td>" + card.last4 + "</td>"
          + "<td>" + card.exp_month + " / " + card.exp_year + "</td>"
          + "<td><span class='label label-success'>New card added!</span></td>"
        + "</tr>"
      );

      if ($("#yes-card-panel table tbody tr").length == 1) {
        $("#no-card-panel").slideUp();
        $("#yes-card-panel").slideDown();
      }
    } else {
      // Show the errors on the form
      stripe_form.find('.error-block').show().find('.inner').text(poller.message);
      stripe_form.find('button').prop('disabled', false);
      $('#stripe-spinner').hide();
    }
  }

  function addCardError() {
    var stripe_form = $('#stripe-form');
    stripe_form.find('.error-block').show().find('.inner')
      .text("There was a problem adding your card, please try again later.");
    stripe_form.find('button').prop('disabled', false);
    $('#stripe-spinner').hide();
  }

  function deleteCardCompleted(poller) {
    if (poller.status == 'successful') {
      $("tr[data-id=" + deletedCardId + "]").remove();
      if ($("#yes-card-panel table tbody tr").length == 0) {
        $("#yes-card-panel").slideUp();
        $("#no-card-panel").slideDown();
      }
      $("#delete-card-spinner").fadeOut();
    } else {
      $("tr[data-id=" + deletedCardId + "] td:last-child")
        .html("<span class='label label-warning'>"
          + "<i class='fa fa-exclamation-triangle'></i> " + poller.message + "</span>");
      $("#delete-card-spinner").fadeOut();
    }
  }

  function deleteCardError() {
    $("tr[data-id=" + deletedCardId + "] td:last-child")
      .html("<span class='label label-warning'>"
        + "<i class='fa fa-exclamation-triangle'></i> Error removing card</span>");
    $("#delete-card-spinner").fadeOut();
  }

</script>

<% 
  if @user.errors.blank?
    form_error = nil
  elsif !@user.errors[:password].blank? || !@user.errors[:password_confirmation].blank?
    form_error = 'change-password'
  else
    form_error = 'edit-user-info'
  end 
%>

<% if !@user.confirmed? || @user.pending_reconfirmation? %>
  <div class="well well-tertiary add-top-margin">
    <i class="fa fa-exclamation-triangle header-icon"></i>
    <h2>Email verification needed</h2>
    <p>
      You need to click the verification link to confirm your Badge List account.
      (<%= link_to 'Click here to get a new link', new_confirmation_path(resource_name) %>)
    </p>
  </div>
<% end %>

<div class="row add-top-margin">
  <div class="span12">
    <div class="header-bar user-header-bar">
      <table class="info-table">
        <tbody>
          <tr class="body-row">
            <td class="left-image">
              <%= gravatar_for(@user, :size => 100, :class => 'img-circle') %>
            </td>
            <td class="single-panel">
              <h1><%= @user.name %></h1>
              <h2><%= @user.username_with_caps %></h2>
              <h3><i class="fa fa-envelope"></i> <%= @user.email %></h3>
            </td>
          </tr>

          <tr class="footer-row">
            <td colspan="2">
              <span class="label-text">
                You've been a Badge List member since 
                <%= @user.created_at.to_s(:full_date) %>
              </span>
              <ul class="action-list">
                <li>
                  <%= link_to \
                    "<i class='fa fa-exclamation-circle'></i> Delete your account".html_safe, 
                    registration_path(resource_name), 
                    :data => { :confirm => "Are you absoluetly sure? This can't be undone." }, 
                    :method => :delete, :class => "btn btn-small" %>
                </li>
                <li>
                  <%= link_to "<i class='fa fa-shield'></i> View your badge profile".html_safe, 
                    user_path(@user), class: 'btn btn-small' %>
                </li>
              </ul>
            </td>
          </tr>

        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- === GROUP LIST === -->

<div class="row">
  <div class="span12">
    <div class="tab-header merge-with-card <%= (@user.owned_group_ids.blank?) ? 'empty' : '' %>">
      <%= link_to "<i class='fa fa-plus'></i> Create new group".html_safe, new_group_path, 
        class: "btn btn-small" %>

      <h2>Groups you own</h2>
    </div>
  </div>
</div>

<% unless @user.owned_group_ids.blank? %>
  <div class="row" id="topic-list-row">
    <div class="span12">
      <div class="info-card text-card group-list-card">
        <ul>
          <% @user.owned_groups.asc(:name).each do |group| %>
            <li>
              <%= link_to group_image_tag_for(group) + " " + group.name, group, 
                title: "View the learning group" %>
              <span class="no-link">
                <% if group.private? %>
                  <i class="fa fa-lock"></i> Private
                <% else %>
                  <i class="fa fa-globe"></i> Public
                <% end %>
              </span>
            </li>
          <% end %>
        </ul>
      </div>
    </div>
  </div>
<% end %>

<!-- === BILLING INFO === -->

<div class="row">
  <div class="span12">
    <div class="tab-header merge-with-card">
      <h2>Billing info</h2>
      <h3><i class="fa fa-lock"></i> Stored securely in Stripe</h3>
    </div>
  </div>
</div>

<div class="row" id="billing-info-row">
  <div class="span12">
    <div class="info-card text-card">

      <div class="spinner-wrapper" id="delete-card-spinner" style="display: none;">
        <div class="spinner large tertiary">&nbsp;</div>
      </div>

      <div class="header-block">
        <div id="credit-card-buttons">
          <a tabindex="-1" class="btn btn-small btn-primary" id="add-card" data-toggle="custom" 
              data-hide="#credit-card-buttons,#billing-info-row" data-show="#add-card-form"
              data-focus="input[data-stripe=number]">
            <i class='fa fa-credit-card'></i> Add a credit card
          </a>
        </div>

        <h3>Credit Cards</h3>
      </div>
      
      <div id="yes-card-panel" style="<%= (@user.has_stripe_card?) ? '' : 'display: none;' %>">
        <table class="table with-border">
          <thead>
            <tr>
              <th>Card Type</th>
              <th>Last 4</th>
              <th>Expiration</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @user.stripe_cards.each do |card| %>
              <tr data-id="<%= card['id'] %>">
                <td><%= card['brand'] %></td>
                <td><%= card['last4'] %></td>
                <td><%= card['exp_month'] %> / <%= card['exp_year'] %></td>
                <td>
                  <%= link_to "<i class='fa fa-remove'></i> Remove Card".html_safe, 
                    '#', class: 'btn btn-small', data: { type: 'delete-card', 
                      id: card['id'] } %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <div id="no-card-panel" style="<%= (@user.has_stripe_card?) ? 'display: none;' : '' %>">
        <table class="table with-border">
          <tbody>
            <tr>
              <td>
                You haven't added any credit cards to your account yet.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<!-- === BILLING INFO === -->

<div class="bl-inline-form" id="add-card-form" style="display: none;">
  <%= simple_form_for @user, html: { class: 'form-horizontal', id: 'stripe-form' } do |f| %>
    
    <div class="spinner-wrapper" id="stripe-spinner" style="display: none;">
      <div class="spinner large tertiary">&nbsp;</div>
    </div>

    <div class="form-body">
      <%= render 'shared/stripe_card_form_fields' %>
    </div>

    <div class="form-footer">
      <%= f.button :submit, "Save new card", :class => "btn btn-info" %>
      <a class="btn" data-toggle="custom"  data-hide="#add-card-form" 
        data-show="#credit-card-buttons,#billing-info-row">Cancel</a>
    </div>

  <% end %>
</div>

<!-- === ACCOUNT DETAILS === -->

<div class="row">
  <div class="span12">
    <div class="tab-header merge-with-card">
      <div id="account-edit-buttons" style="<%= (form_error) ? 'display: none;' : '' %>">
        <a tabindex="-1" class="btn btn-small" id="edit-user-info" data-toggle="custom" 
          data-hide="#account-edit-buttons,#account-details-row" data-show="#edit-user-info-form"
          data-focus="#user_email">

          <i class="fa fa-pencil"></i> Edit user info
        </a>
        <a tabindex="-1" class="btn btn-small" id="change-password" data-toggle="custom" 
          data-hide="#account-edit-buttons,#account-details-row" 
          data-focus="#user_current_password" data-show="#change-password-form">

          <i class="fa fa-key"></i> Change password
        </a>
      </div>

      <h2>Update account details</h2>
    </div>
  </div>
</div>

<div class="row" id="account-details-row" style="<%= (form_error) ? 'display: none;' : '' %>">
  <div class="span12">
    <div class="info-card text-card">
      Click one of the buttons in the header above to edit your account details.
    </div>
  </div>
</div>

<!-- === CHANGE PASSWORD FORM === -->

<div class="bl-inline-form" id="change-password-form" 
    style="<%= (form_error == 'change-password') ? '' : 'display: none;' %>">
  <%= simple_form_for(resource, :as => resource_name, :url => registration_path(resource_name), 
      :html => { :method => :put, :class => 'form-horizontal' }) do |f| %>
    
    <div class="form-body">
      <%= f.error_notification %>
      
      <%= f.input :email, :as => :hidden, :required => true %>
      <%= f.input :current_password, :required => true %>
      <%= f.input :password, :label => 'New password', :autocomplete => "off", :required => true %>
      <%= f.input :password_confirmation, :label => 'Confirm new password', :autocomplete => "off", 
        :required => true %>
    </div>

    <div class="form-footer">
      <%= f.button :submit, "Change password", :class => "btn btn-info" %>
      <a class="btn" data-toggle="custom"  data-hide="#change-password-form" 
        data-show="#account-edit-buttons,#account-details-row">Cancel</a>
    </div>

  <% end %>
</div>

<!-- === EDIT USER INFO FORM === -->

<div class="bl-inline-form" id="edit-user-info-form" 
    style="<%= (form_error == 'edit-user-info') ? '' : 'display: none;' %>">
  <%= simple_form_for(resource, :as => resource_name, :url => registration_path(resource_name), 
      :html => { :method => :put, :class => 'form-horizontal' }) do |f| %>
    
    <div class="form-body">
      <%= f.error_notification %>
      
      <%= f.input :email, :label => "Your email" %>
      <%= f.input :name, :label => "Your full name" %>
      <%= f.input :username_with_caps, :label => "Your username" %>
      <%= f.input :current_password, :label => "Confirm your password", :required => true %>
    </div>

    <div class="form-footer">
      <%= f.button :submit, "Update info", :class => "btn btn-info" %>
      <a class="btn" data-toggle="custom"  data-hide="#edit-user-info-form" 
        data-show="#account-edit-buttons,#account-details-row">Cancel</a>
    </div>

  <% end %>
</div>